<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠ©æ‰‹åˆ›å»ºæ—¥ç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .test-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fb;
            border-radius: 8px;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
        }
        .task-list {
            margin-top: 15px;
        }
        .task-item {
            padding: 10px;
            background: white;
            border: 1px solid #e8eef5;
            border-radius: 6px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.blue { background: #e3f2fd; color: #1976d2; }
        .badge.red { background: #ffebee; color: #c62828; }
        .badge.green { background: #e8f5e9; color: #2e7d32; }
        .badge.orange { background: #fff3e0; color: #ef6c00; }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>ğŸ§ª AIåŠ©æ‰‹åˆ›å»ºæ—¥ç¨‹åŠŸèƒ½æµ‹è¯•</h1>
        <p style="color: #666; margin-bottom: 20px;">
            æ­¤é¡µé¢ç”¨äºæµ‹è¯•AIåŠ©æ‰‹æ˜¯å¦èƒ½æ­£ç¡®åˆ›å»ºæ—¥å†æ—¥ç¨‹
        </p>

        <div class="test-section">
            <div class="test-title">1ï¸âƒ£ æ£€æŸ¥ç¯å¢ƒ</div>
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
            <div id="envStatus"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2ï¸âƒ£ åˆå§‹åŒ–æ¨¡æ‹Ÿæ—¥å†æ•°æ®</div>
            <button onclick="initMockData()">åˆå§‹åŒ–æ•°æ®</button>
            <div id="initStatus"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3ï¸âƒ£ æµ‹è¯•åˆ›å»ºå·¥å•</div>
            <button onclick="testCreateTask()">æµ‹è¯•åˆ›å»ºå·¥å•</button>
            <div id="createStatus"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4ï¸âƒ£ æ‰“å¼€AIåŠ©æ‰‹è¿›è¡Œå®é™…æµ‹è¯•</div>
            <button onclick="openAIAssistant()">æ‰“å¼€AIåŠ©æ‰‹</button>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
                åœ¨AIåŠ©æ‰‹ä¸­è¾“å…¥ï¼š<br>
                <code style="background: #f0f0f0; padding: 5px; border-radius: 3px;">
                    åˆ›å»ºæ˜å¤©ä¸Šåˆ9ç‚¹åˆ°12ç‚¹çš„å®‰è£…å·¥å•ï¼Œåœ°ç‚¹æµ¦ä¸œå¼ æ±Ÿï¼Œè½¦ç‰Œæ²ªA12345ï¼Œå®‰è£…äººå‘˜ææ˜
                </code>
            </p>
            <div id="aiStatus"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5ï¸âƒ£ å½“å‰ä»»åŠ¡åˆ—è¡¨</div>
            <button onclick="refreshTaskList()">åˆ·æ–°åˆ—è¡¨</button>
            <div id="taskList" class="task-list"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ—¥å†é¡µé¢ç¯å¢ƒ
        window.tasks = [];
        
        let aiAssistantWindow = null;

        // æ£€æŸ¥ç¯å¢ƒ
        function checkEnvironment() {
            const statusEl = document.getElementById('envStatus');
            let html = '<div class="status info" style="margin-top: 10px;">';
            
            // æ£€æŸ¥window.tasks
            if (typeof window.tasks !== 'undefined') {
                html += 'âœ… window.tasks å·²å®šä¹‰<br>';
            } else {
                html += 'âŒ window.tasks æœªå®šä¹‰<br>';
            }
            
            // æ£€æŸ¥addTaskFromAI
            if (typeof window.addTaskFromAI === 'function') {
                html += 'âœ… window.addTaskFromAI å‡½æ•°å­˜åœ¨<br>';
            } else {
                html += 'âš ï¸ window.addTaskFromAI å‡½æ•°ä¸å­˜åœ¨ï¼ˆå°†è‡ªåŠ¨åˆ›å»ºï¼‰<br>';
                createAddTaskFromAI();
            }
            
            // æ£€æŸ¥localStorage
            if (typeof localStorage !== 'undefined') {
                html += 'âœ… localStorage å¯ç”¨<br>';
            } else {
                html += 'âŒ localStorage ä¸å¯ç”¨<br>';
            }
            
            html += '</div>';
            statusEl.innerHTML = html;
        }

        // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®
        function initMockData() {
            window.tasks = [
                { id: 1, number: 'W001', plate: 'æ²ªA88888', staff: 'ææ˜', date: '2024-11-20', time: '09:00-12:00', location: 'æµ¦ä¸œé™†å®¶å˜´', service: 'å®‰è£…', color: 'blue', type: 'å¸¸è§„è®¢å•' },
                { id: 2, number: 'W002', plate: 'æ²ªB12345', staff: 'å¼ ä¸‰', date: '2024-11-21', time: '14:00-17:00', location: 'å¾æ±‡ä¸­å±±', service: 'é‡å°º', color: 'green', type: 'å¸¸è§„è®¢å•' }
            ];
            
            const statusEl = document.getElementById('initStatus');
            statusEl.innerHTML = '<div class="status success" style="margin-top: 10px;">âœ… å·²åˆå§‹åŒ– ' + window.tasks.length + ' ä¸ªæµ‹è¯•å·¥å•</div>';
            
            refreshTaskList();
        }

        // åˆ›å»ºaddTaskFromAIå‡½æ•°ï¼ˆæ¨¡æ‹Ÿä¸»æ—¥å†é¡µé¢çš„åŠŸèƒ½ï¼‰
        function createAddTaskFromAI() {
            window.addTaskFromAI = function(taskData) {
                console.log('æ”¶åˆ°åˆ›å»ºä»»åŠ¡è¯·æ±‚:', taskData);
                
                const newId = window.tasks.length > 0 
                    ? Math.max(...window.tasks.map(t => t.id), 0) + 1 
                    : 1;
                
                const newTask = {
                    id: newId,
                    number: taskData.number,
                    plate: taskData.plate,
                    staff: taskData.staff,
                    date: taskData.date,
                    time: taskData.time,
                    location: taskData.location,
                    service: taskData.service || 'å®‰è£…',
                    note: taskData.note || '',
                    color: taskData.color || 'blue',
                    type: taskData.number.startsWith('G') ? 'å·¥ç¨‹å•' : 'å¸¸è§„è®¢å•'
                };
                
                window.tasks.push(newTask);
                
                console.log('ä»»åŠ¡åˆ›å»ºæˆåŠŸ:', newTask);
                
                // åˆ·æ–°æ˜¾ç¤º
                refreshTaskList();
                
                return newTask;
            };
        }

        // æµ‹è¯•åˆ›å»ºå·¥å•
        function testCreateTask() {
            if (typeof window.addTaskFromAI !== 'function') {
                createAddTaskFromAI();
            }

            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];

            const testTaskData = {
                number: 'W' + String(window.tasks.length + 1).padStart(3, '0'),
                plate: 'æ²ªA12345',
                staff: 'ææ˜',
                date: dateStr,
                time: '09:00-12:00',
                location: 'æµ¦ä¸œå¼ æ±Ÿ',
                service: 'å®‰è£…',
                color: 'blue'
            };

            try {
                const newTask = window.addTaskFromAI(testTaskData);
                
                const statusEl = document.getElementById('createStatus');
                statusEl.innerHTML = `
                    <div class="status success" style="margin-top: 10px;">
                        âœ… æµ‹è¯•å·¥å•åˆ›å»ºæˆåŠŸï¼<br><br>
                        <strong>å·¥å•ä¿¡æ¯ï¼š</strong><br>
                        â€¢ å·¥å•å·ï¼š${newTask.number}<br>
                        â€¢ æ—¥æœŸï¼š${newTask.date}<br>
                        â€¢ æ—¶é—´ï¼š${newTask.time}<br>
                        â€¢ åœ°ç‚¹ï¼š${newTask.location}<br>
                        â€¢ äººå‘˜ï¼š${newTask.staff}<br>
                        â€¢ è½¦ç‰Œï¼š${newTask.plate}
                    </div>
                `;
            } catch (error) {
                const statusEl = document.getElementById('createStatus');
                statusEl.innerHTML = `<div class="status error" style="margin-top: 10px;">âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}</div>`;
            }
        }

        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        function refreshTaskList() {
            const listEl = document.getElementById('taskList');
            
            if (!window.tasks || window.tasks.length === 0) {
                listEl.innerHTML = '<p style="color: #999; padding: 10px;">æš‚æ— ä»»åŠ¡</p>';
                return;
            }

            let html = '';
            window.tasks.forEach(task => {
                html += `
                    <div class="task-item">
                        <div>
                            <strong>${task.number}</strong> - ${task.staff} | ${task.date} ${task.time}
                            <br>
                            <small style="color: #666;">${task.location} | ${task.plate}</small>
                        </div>
                        <span class="badge ${task.color}">${task.service}</span>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }

        // æ‰“å¼€AIåŠ©æ‰‹
        function openAIAssistant() {
            if (aiAssistantWindow && !aiAssistantWindow.closed) {
                aiAssistantWindow.focus();
                document.getElementById('aiStatus').innerHTML = '<div class="status info" style="margin-top: 10px;">âœ… AIåŠ©æ‰‹çª—å£å·²æ‰“å¼€ï¼Œè¯·åœ¨å…¶ä¸­æµ‹è¯•åˆ›å»ºåŠŸèƒ½</div>';
                return;
            }

            const width = 1200;
            const height = 800;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            aiAssistantWindow = window.open(
                'frontend/ai_assistant.html',
                'AIæ™ºèƒ½åŠ©æ‰‹',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );

            if (!aiAssistantWindow) {
                document.getElementById('aiStatus').innerHTML = '<div class="status error" style="margin-top: 10px;">âŒ æ— æ³•æ‰“å¼€AIåŠ©æ‰‹çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®</div>';
            } else {
                document.getElementById('aiStatus').innerHTML = '<div class="status success" style="margin-top: 10px;">âœ… AIåŠ©æ‰‹çª—å£å·²æ‰“å¼€ï¼<br><br>è¯·åœ¨AIåŠ©æ‰‹ä¸­è¾“å…¥åˆ›å»ºæ—¥ç¨‹çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š<br>"åˆ›å»ºæ˜å¤©ä¸Šåˆ9ç‚¹åˆ°12ç‚¹çš„å®‰è£…å·¥å•ï¼Œåœ°ç‚¹æµ¦ä¸œå¼ æ±Ÿï¼Œè½¦ç‰Œæ²ªA12345ï¼Œå®‰è£…äººå‘˜ææ˜"</div>';
                
                // æ¯2ç§’è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                const refreshInterval = setInterval(() => {
                    if (aiAssistantWindow && !aiAssistantWindow.closed) {
                        refreshTaskList();
                    } else {
                        clearInterval(refreshInterval);
                    }
                }, 2000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            checkEnvironment();
            initMockData();
        };
    </script>
</body>
</html>
