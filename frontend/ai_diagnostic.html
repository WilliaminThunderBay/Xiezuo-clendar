<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠ©æ‰‹è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .code-block {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #667eea;">ğŸ” AIåŠ©æ‰‹è¿æ¥è¯Šæ–­å·¥å…·</h1>

    <div class="test-card">
        <div class="test-title">1ï¸âƒ£ æµ‹è¯•ä¸»çª—å£è®¿é—®</div>
        <button onclick="testParentWindow()">æµ‹è¯•çˆ¶çª—å£è¿æ¥</button>
        <div id="parentResult"></div>
    </div>

    <div class="test-card">
        <div class="test-title">2ï¸âƒ£ æµ‹è¯•tasksæ•°ç»„</div>
        <button onclick="testTasksArray()">æ£€æŸ¥tasksæ•°ç»„</button>
        <div id="tasksResult"></div>
    </div>

    <div class="test-card">
        <div class="test-title">3ï¸âƒ£ æµ‹è¯•åˆ›å»ºå·¥å•</div>
        <button onclick="testCreateTask()">æµ‹è¯•åˆ›å»ºå·¥å•</button>
        <div id="createResult"></div>
    </div>

    <div class="test-card">
        <div class="test-title">4ï¸âƒ£ æŸ¥çœ‹localStorage</div>
        <button onclick="testLocalStorage()">æŸ¥çœ‹å­˜å‚¨æ•°æ®</button>
        <div id="storageResult"></div>
    </div>

    <div class="test-card">
        <div class="test-title">5ï¸âƒ£ ä½¿ç”¨è¯´æ˜</div>
        <div class="info test-result">
            <strong>ğŸ“ æ­£ç¡®çš„ä½¿ç”¨æµç¨‹ï¼š</strong><br><br>
            1. æ‰“å¼€ä¸»é¡µé¢ï¼šinstallation_schedule.html<br>
            2. ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½ï¼ˆçœ‹åˆ°æ—¥å†æ˜¾ç¤ºï¼‰<br>
            3. ç‚¹å‡»å³ä¸Šè§’çš„ ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹ æŒ‰é’®<br>
            4. åœ¨AIåŠ©æ‰‹çª—å£ä¸­è¾“å…¥åˆ›å»ºæŒ‡ä»¤<br><br>
            <strong>âš ï¸ é”™è¯¯çš„ä½¿ç”¨æ–¹å¼ï¼š</strong><br>
            - âŒ ç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€ ai_assistant.html<br>
            - âŒ åœ¨ä¸»é¡µé¢åŠ è½½å®Œæˆå‰æ‰“å¼€AIåŠ©æ‰‹<br>
        </div>
    </div>

    <script>
        // æµ‹è¯•çˆ¶çª—å£è¿æ¥
        function testParentWindow() {
            const resultDiv = document.getElementById('parentResult');
            let html = '';

            try {
                const parentWindow = window.opener || window.parent;
                
                if (!parentWindow || parentWindow === window) {
                    html = `<div class="error test-result">
                        âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°çˆ¶çª—å£<br><br>
                        <strong>åŸå› ï¼š</strong>å½“å‰é¡µé¢ä¸æ˜¯ä»ä¸»çª—å£æ‰“å¼€çš„<br>
                        <strong>è§£å†³ï¼š</strong>è¯·ä» installation_schedule.html é¡µé¢ç‚¹å‡» ğŸ¤– æŒ‰é’®æ‰“å¼€
                    </div>`;
                } else {
                    html = `<div class="success test-result">
                        âœ… æˆåŠŸï¼šçˆ¶çª—å£è¿æ¥æ­£å¸¸<br>
                        çª—å£å¯¹è±¡ï¼š${parentWindow.constructor.name}<br>
                        çª—å£ä½ç½®ï¼š${parentWindow.location.href}
                    </div>`;
                    
                    // æ£€æŸ¥tasks
                    if (typeof parentWindow.tasks !== 'undefined') {
                        html += `<div class="success test-result">
                            âœ… tasksæ•°ç»„å­˜åœ¨<br>
                            ç±»å‹ï¼š${typeof parentWindow.tasks}<br>
                            æ˜¯å¦ä¸ºæ•°ç»„ï¼š${Array.isArray(parentWindow.tasks)}<br>
                            æ•°é‡ï¼š${parentWindow.tasks ? parentWindow.tasks.length : 0} ä¸ªå·¥å•
                        </div>`;
                    } else {
                        html += `<div class="error test-result">
                            âŒ tasksæ•°ç»„ä¸å­˜åœ¨<br>
                            è¯·åˆ·æ–°ä¸»çª—å£å¹¶ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                        </div>`;
                    }
                }
            } catch (error) {
                html = `<div class="error test-result">
                    âŒ é”™è¯¯ï¼š${error.message}<br>
                    å †æ ˆï¼š${error.stack}
                </div>`;
            }

            resultDiv.innerHTML = html;
        }

        // æµ‹è¯•tasksæ•°ç»„
        function testTasksArray() {
            const resultDiv = document.getElementById('tasksResult');
            let html = '';

            try {
                const parentWindow = window.opener || window.parent;
                
                if (!parentWindow || parentWindow === window) {
                    html = `<div class="error test-result">âŒ æ— æ³•è®¿é—®çˆ¶çª—å£</div>`;
                } else if (!parentWindow.tasks) {
                    html = `<div class="error test-result">
                        âŒ tasksæ•°ç»„æœªå®šä¹‰<br><br>
                        <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                        1. ä¸»é¡µé¢scriptæ ‡ç­¾æœªæ‰§è¡Œ<br>
                        2. é¡µé¢åŠ è½½ä¸å®Œæ•´<br>
                        3. JavaScripté”™è¯¯é˜»æ­¢äº†åˆå§‹åŒ–<br><br>
                        <strong>è§£å†³æ–¹æ³•ï¼š</strong><br>
                        1. åˆ·æ–°ä¸»é¡µé¢ï¼ˆF5ï¼‰<br>
                        2. æ‰“å¼€ä¸»é¡µé¢æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯<br>
                        3. ç¡®ä¿æ²¡æœ‰JSé”™è¯¯åé‡æ–°æ‰“å¼€AIåŠ©æ‰‹
                    </div>`;
                } else {
                    const tasks = parentWindow.tasks;
                    html = `<div class="success test-result">
                        âœ… tasksæ•°ç»„æ­£å¸¸<br>
                        æ€»æ•°ï¼š${tasks.length} ä¸ªå·¥å•<br>
                        ç±»å‹ï¼š${Array.isArray(tasks) ? 'æ•°ç»„' : typeof tasks}
                    </div>`;
                    
                    if (tasks.length > 0) {
                        html += `<div class="code-block">
                            <strong>æœ€è¿‘3ä¸ªå·¥å•ï¼š</strong><br>
                            <pre>${JSON.stringify(tasks.slice(0, 3), null, 2)}</pre>
                        </div>`;
                    }
                }
            } catch (error) {
                html = `<div class="error test-result">âŒ ${error.message}</div>`;
            }

            resultDiv.innerHTML = html;
        }

        // æµ‹è¯•åˆ›å»ºå·¥å•
        function testCreateTask() {
            const resultDiv = document.getElementById('createResult');
            let html = '';

            try {
                const parentWindow = window.opener || window.parent;
                
                if (!parentWindow || parentWindow === window) {
                    html = `<div class="error test-result">âŒ æ— æ³•è®¿é—®çˆ¶çª—å£</div>`;
                } else if (!parentWindow.tasks) {
                    html = `<div class="error test-result">âŒ tasksæ•°ç»„ä¸å­˜åœ¨</div>`;
                } else {
                    // åˆ›å»ºæµ‹è¯•å·¥å•
                    const testTask = {
                        id: Math.max(...parentWindow.tasks.map(t => t.id), 0) + 1,
                        number: 'W' + String(Math.max(...parentWindow.tasks.map(t => parseInt(t.number.replace(/\D/g, '')) || 0), 0) + 1).padStart(3, '0'),
                        plate: 'æ²ªAÂ·TEST',
                        staff: 'æµ‹è¯•å‘˜å·¥',
                        date: new Date().toISOString().split('T')[0],
                        time: '09:00-12:00',
                        location: 'æµ‹è¯•åœ°ç‚¹',
                        service: 'å®‰è£…',
                        note: 'è¿™æ˜¯è¯Šæ–­å·¥å…·åˆ›å»ºçš„æµ‹è¯•å·¥å•',
                        color: 'blue',
                        type: 'å¸¸è§„è®¢å•'
                    };

                    const beforeCount = parentWindow.tasks.length;
                    parentWindow.tasks.push(testTask);
                    const afterCount = parentWindow.tasks.length;

                    html = `<div class="success test-result">
                        âœ… å·¥å•åˆ›å»ºæˆåŠŸ<br><br>
                        å·¥å•å·ï¼š${testTask.number}<br>
                        åˆ›å»ºå‰æ•°é‡ï¼š${beforeCount}<br>
                        åˆ›å»ºåæ•°é‡ï¼š${afterCount}<br>
                        å¢åŠ ï¼š${afterCount - beforeCount} ä¸ª
                    </div>`;

                    // å°è¯•åˆ·æ–°æ—¥å†
                    if (typeof parentWindow.renderCalendar === 'function') {
                        parentWindow.renderCalendar();
                        html += `<div class="success test-result">âœ… å·²åˆ·æ–°æ—¥å†</div>`;
                    } else {
                        html += `<div class="error test-result">âŒ renderCalendarå‡½æ•°ä¸å­˜åœ¨</div>`;
                    }

                    // ä¿å­˜åˆ°localStorage
                    try {
                        localStorage.setItem('installationTasks', JSON.stringify(parentWindow.tasks));
                        html += `<div class="success test-result">âœ… å·²ä¿å­˜åˆ°localStorage</div>`;
                    } catch (e) {
                        html += `<div class="error test-result">âŒ localStorageä¿å­˜å¤±è´¥: ${e.message}</div>`;
                    }
                }
            } catch (error) {
                html = `<div class="error test-result">âŒ ${error.message}<br><pre>${error.stack}</pre></div>`;
            }

            resultDiv.innerHTML = html;
        }

        // æµ‹è¯•localStorage
        function testLocalStorage() {
            const resultDiv = document.getElementById('storageResult');
            let html = '';

            try {
                const stored = localStorage.getItem('installationTasks');
                
                if (!stored) {
                    html = `<div class="info test-result">
                        â„¹ï¸ localStorageä¸­æš‚æ— æ•°æ®<br>
                        è¿™æ˜¯æ­£å¸¸çš„ï¼Œæ•°æ®ä¼šåœ¨åˆ›å»ºå·¥å•åè‡ªåŠ¨ä¿å­˜
                    </div>`;
                } else {
                    const tasks = JSON.parse(stored);
                    html = `<div class="success test-result">
                        âœ… localStorageæ•°æ®å­˜åœ¨<br>
                        å·¥å•æ•°é‡ï¼š${tasks.length}<br>
                        æ•°æ®å¤§å°ï¼š${(stored.length / 1024).toFixed(2)} KB
                    </div>`;
                    
                    html += `<div class="code-block">
                        <strong>å­˜å‚¨çš„æ•°æ®ï¼ˆæœ€è¿‘3æ¡ï¼‰ï¼š</strong><br>
                        <pre>${JSON.stringify(tasks.slice(0, 3), null, 2)}</pre>
                    </div>`;
                }
            } catch (error) {
                html = `<div class="error test-result">âŒ ${error.message}</div>`;
            }

            resultDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            testParentWindow();
        });
    </script>
</body>
</html>
