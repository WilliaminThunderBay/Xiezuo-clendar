<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åä½œä¸­å¿ƒ - å·¥ç¨‹å®‰è£…æœˆå†ç®¡ç†ç³»ç»Ÿ</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="app-config.js"></script>
    <script src="collaboration-client.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .online-users-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .user-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 14px;
            position: relative;
        }

        .user-status-dot {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid white;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            color: #333;
        }

        .user-activity {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .message-author {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: #9ca3af;
        }

        .message-content {
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .mention {
            color: #667eea;
            background: #eef2ff;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 500;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .send-button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 12px;
            border-left: 3px solid #667eea;
            background: #f9fafb;
            margin-bottom: 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .activity-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .activity-user {
            font-weight: 600;
            color: #667eea;
        }

        .activity-action {
            color: #6b7280;
            font-size: 14px;
        }

        .activity-time {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s;
            z-index: 1000;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .notification-message {
            font-size: 14px;
            color: #6b7280;
        }

        .back-button {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>ğŸ¤</span>
                å®æ—¶åä½œä¸­å¿ƒ
            </h1>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="connectionStatus">è¿æ¥ä¸­...</span>
                </div>
                <button class="back-button" onclick="window.location.href='installation_schedule.html'">
                    â† è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>

        <div class="grid">
            <!-- åœ¨çº¿ç”¨æˆ· -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ‘¥ åœ¨çº¿ç”¨æˆ·</h2>
                    <span class="badge" id="onlineCount">0</span>
                </div>
                <div class="online-users-list" id="onlineUsersList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div>æš‚æ— åœ¨çº¿ç”¨æˆ·</div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶èŠå¤© -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ’¬ å›¢é˜ŸèŠå¤©</h2>
                    <span class="badge" id="unreadCount">0</span>
                </div>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div>å¼€å§‹èŠå¤©å§ï¼</div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input 
                            type="text" 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="è¾“å…¥æ¶ˆæ¯... (ä½¿ç”¨ @ç”¨æˆ·å æ¥æé†’ä»–äºº)"
                            disabled
                        />
                        <button class="send-button" id="sendButton" disabled>å‘é€</button>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘æ´»åŠ¨ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">âš¡ å®æ—¶æ´»åŠ¨</h2>
                    <button class="btn btn-secondary" onclick="loadActivities()">åˆ·æ–°</button>
                </div>
                <div class="activity-list" id="activityList">
                    <div class="empty-state">
                        <div class="empty-state-icon">âš¡</div>
                        <div>æš‚æ— æ´»åŠ¨</div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡ç¼–è¾‘çŠ¶æ€ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">âœï¸ æ­£åœ¨ç¼–è¾‘</h2>
                </div>
                <div class="activity-list" id="editingStatus">
                    <div class="empty-state">
                        <div class="empty-state-icon">âœï¸</div>
                        <div>æš‚æ— äººç¼–è¾‘ä»»åŠ¡</div>
                    </div>
                </div>
            </div>

            <!-- åä½œç»Ÿè®¡ -->
            <div class="card full-width">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“Š åä½œç»Ÿè®¡</h2>
                    <button class="btn btn-secondary" onclick="loadStats()">åˆ·æ–°</button>
                </div>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="statActiveUsers">0</div>
                        <div class="stat-label">æ´»è·ƒåä½œè€…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statActivities">0</div>
                        <div class="stat-label">ä»Šæ—¥æ´»åŠ¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statComments">0</div>
                        <div class="stat-label">ä»Šæ—¥è¯„è®º</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statMessages">0</div>
                        <div class="stat-label">èŠå¤©æ¶ˆæ¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statCollabRate">0%</div>
                        <div class="stat-label">åä½œé¡¹ç›®æ¯”ä¾‹</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allUsers = [];
        let chatMessagesCache = [];

        // åˆå§‹åŒ–
        async function init() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            try {
                const response = await fetchWithAuth('/api/auth/me');
                currentUser = response;
                
                // è¿æ¥ WebSocket
                connectWebSocket(token);
                
                // åŠ è½½åˆå§‹æ•°æ®
                await loadAllUsers();
                await loadChatMessages();
                await loadActivities();
                await loadStats();
                
                // å¯ç”¨èŠå¤©è¾“å…¥
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
                // ç»‘å®šäº‹ä»¶
                bindEvents();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('é”™è¯¯', 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'âŒ');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        // è¿æ¥ WebSocket
        function connectWebSocket(token) {
            const client = window.collaborationClient;
            
            client.on('connected', () => {
                updateConnectionStatus(true);
                showNotification('è¿æ¥æˆåŠŸ', 'å®æ—¶åä½œåŠŸèƒ½å·²å¯ç”¨', 'âœ…');
            });

            client.on('disconnected', (reason) => {
                updateConnectionStatus(false);
                showNotification('è¿æ¥æ–­å¼€', 'æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...', 'âš ï¸');
            });

            client.on('online-users', (users) => {
                renderOnlineUsers(users);
            });

            client.on('user-online', (data) => {
                showNotification('ç”¨æˆ·ä¸Šçº¿', `${data.username} åŠ å…¥äº†åä½œ`, 'ğŸ‘‹');
                loadOnlineUsers();
            });

            client.on('user-offline', (data) => {
                showNotification('ç”¨æˆ·ç¦»çº¿', `${data.username} ç¦»å¼€äº†`, 'ğŸ‘‹');
                loadOnlineUsers();
            });

            client.on('chat-message', (message) => {
                addChatMessage(message);
            });

            client.on('mention', (data) => {
                showNotification('æœ‰äºº@äº†ä½ ', data.message, 'ğŸ””');
            });

            client.on('notification', (notification) => {
                showNotification(notification.title, notification.message, 'ğŸ””');
            });

            client.on('user-enter-task', (data) => {
                updateEditingStatus();
            });

            client.on('user-leave-task', (data) => {
                updateEditingStatus();
            });

            client.on('task-updated', (data) => {
                loadActivities();
            });

            client.connect(token);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                status.textContent = 'å·²è¿æ¥';
            } else {
                indicator.classList.add('disconnected');
                status.textContent = 'å·²æ–­å¼€';
            }
        }

        // åŠ è½½æ‰€æœ‰ç”¨æˆ·
        async function loadAllUsers() {
            try {
                const response = await fetchWithAuth('/api/staff');
                allUsers = response;
                loadOnlineUsers();
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // åŠ è½½åœ¨çº¿ç”¨æˆ·
        async function loadOnlineUsers() {
            const list = document.getElementById('onlineUsersList');
            const count = document.getElementById('onlineCount');
            
            const client = window.collaborationClient;
            if (!client.isConnected()) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div>æœªè¿æ¥</div></div>';
                return;
            }

            // ä»åä½œå®¢æˆ·ç«¯è·å–åœ¨çº¿ç”¨æˆ·
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä» WebSocket äº‹ä»¶è·å–
            try {
                const response = await fetchWithAuth('/api/online-users');
                const users = response;
                
                count.textContent = users.length;
                
                if (users.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><div>æš‚æ— åœ¨çº¿ç”¨æˆ·</div></div>';
                    return;
                }

                list.innerHTML = users.map(user => `
                    <div class="user-item">
                        <div class="user-avatar" style="background: ${getUserColor(user.name)}">
                            ${getUserInitials(user.name)}
                            <div class="user-status-dot"></div>
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-activity">
                                ${user.editingTask ? `æ­£åœ¨ç¼–è¾‘ ${user.editingTask}` : 'åœ¨çº¿'}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½åœ¨çº¿ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // åŠ è½½èŠå¤©æ¶ˆæ¯
        async function loadChatMessages() {
            try {
                const response = await fetchWithAuth('/api/chat?limit=50');
                chatMessagesCache = response.messages.reverse();
                renderChatMessages();
            } catch (error) {
                console.error('åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
        function renderChatMessages() {
            const container = document.getElementById('chatMessages');
            
            if (chatMessagesCache.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div><div>å¼€å§‹èŠå¤©å§ï¼</div></div>';
                return;
            }

            container.innerHTML = chatMessagesCache.map(msg => `
                <div class="chat-message">
                    <div class="message-header">
                        <span class="message-author">${msg.username}</span>
                        <span class="message-time">${formatTime(msg.createdAt)}</span>
                    </div>
                    <div class="message-content">
                        ${highlightMentions(msg.message)}
                    </div>
                </div>
            `).join('');

            container.scrollTop = container.scrollHeight;
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(message) {
            chatMessagesCache.push(message);
            renderChatMessages();
            
            // å¦‚æœä¸æ˜¯å½“å‰ç”¨æˆ·å‘çš„æ¶ˆæ¯ï¼Œæ›´æ–°æœªè¯»æ•°
            if (message.userId !== currentUser?.id) {
                updateUnreadCount();
            }
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            try {
                // æå–@mentions
                const mentions = extractMentions(message, allUsers);
                
                // å‘é€åˆ°æœåŠ¡å™¨
                await fetchWithAuth('/api/chat', {
                    method: 'POST',
                    body: JSON.stringify({ message, mentions })
                });

                // é€šè¿‡ WebSocket å®æ—¶å‘é€
                window.collaborationClient.sendChatMessage(message, mentions);

                input.value = '';
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showNotification('å‘é€å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'âŒ');
            }
        }

        // åŠ è½½æ´»åŠ¨åˆ—è¡¨
        async function loadActivities() {
            try {
                const response = await fetchWithAuth('/api/activity');
                const activities = response.slice(0, 20);
                
                const list = document.getElementById('activityList');
                
                if (activities.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš¡</div><div>æš‚æ— æ´»åŠ¨</div></div>';
                    return;
                }

                list.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div>
                            <span class="activity-user">${activity.userName || activity.user}</span>
                            <span class="activity-action">${activity.description || activity.action}</span>
                        </div>
                        <div class="activity-time">${formatTime(activity.timestamp)}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æ´»åŠ¨å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç¼–è¾‘çŠ¶æ€
        async function updateEditingStatus() {
            const container = document.getElementById('editingStatus');
            
            try {
                const response = await fetchWithAuth('/api/online-users');
                const editingUsers = response.filter(u => u.editingTask);
                
                if (editingUsers.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âœï¸</div><div>æš‚æ— äººç¼–è¾‘ä»»åŠ¡</div></div>';
                    return;
                }

                container.innerHTML = editingUsers.map(user => `
                    <div class="activity-item">
                        <div>
                            <span class="activity-user">${user.name}</span>
                            <span class="activity-action">æ­£åœ¨ç¼–è¾‘ ${user.editingTask}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('æ›´æ–°ç¼–è¾‘çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const overview = await fetchWithAuth('/api/collaboration/overview');
                const chatStats = await fetchWithAuth('/api/chat/stats');
                
                document.getElementById('statActiveUsers').textContent = overview.activeCollaborators;
                document.getElementById('statActivities').textContent = overview.totalActivities;
                document.getElementById('statComments').textContent = overview.totalComments;
                document.getElementById('statMessages').textContent = chatStats.totalMessages;
                document.getElementById('statCollabRate').textContent = overview.collaborationRate + '%';
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // å‘é€æŒ‰é’®
            document.getElementById('sendButton').addEventListener('click', sendChatMessage);
            
            // å›è½¦å‘é€
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // å®šæ—¶åˆ·æ–°
            setInterval(loadActivities, 30000); // 30ç§’
            setInterval(updateEditingStatus, 10000); // 10ç§’
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(title, message, icon) {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // å·¥å…·å‡½æ•°
        function getUserColor(name) {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0'];
            const index = name.charCodeAt(0) % colors.length;
            return colors[index];
        }

        function getUserInitials(name) {
            if (!name) return '?';
            const chars = name.split('');
            return chars.length > 1 ? chars.slice(0, 2).join('') : chars[0];
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function updateUnreadCount() {
            const badge = document.getElementById('unreadCount');
            const current = parseInt(badge.textContent) || 0;
            badge.textContent = current + 1;
        }

        function renderOnlineUsers(users) {
            // æ¸²æŸ“åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            loadOnlineUsers();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
