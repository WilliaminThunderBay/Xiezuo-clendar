<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½åŠ©æ‰‹ - DeepSeek</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: #202123;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            color: #ececf1;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid #444654;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #ececf1;
            border: 1px solid #444654;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: #2a2b32;
        }

        /* é¡¹ç›®å’Œå¯¹è¯åˆ—è¡¨ */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        /* é¡¹ç›®åŒºåŸŸ */
        .projects-section {
            margin-bottom: 16px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            color: #8e8ea0;
            font-size: 12px;
            font-weight: 500;
        }

        .section-toggle {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            font-size: 12px;
        }

        .add-project-btn {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            transition: color 0.2s;
        }

        .add-project-btn:hover {
            color: #ececf1;
        }

        .project-item {
            margin-bottom: 8px;
        }

        .project-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 8px;
        }

        .project-header:hover {
            background: #2a2b32;
        }

        .project-icon {
            font-size: 16px;
        }

        .project-name {
            flex: 1;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-toggle {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 2px;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .project-toggle.expanded {
            transform: rotate(90deg);
        }

        .project-actions {
            display: none;
            gap: 4px;
        }

        .project-header:hover .project-actions {
            display: flex;
        }

        .project-btn {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            transition: color 0.2s;
        }

        .project-btn:hover {
            color: #ececf1;
        }

        .project-conversations {
            padding-left: 24px;
            display: none;
        }

        .project-conversations.show {
            display: block;
        }

        /* å¯¹è¯å†å² */
        .history-section {
            margin-bottom: 12px;
        }

        .history-title {
            font-size: 12px;
            color: #8e8ea0;
            padding: 8px 12px;
            font-weight: 500;
        }

        .history-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #ececf1;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .history-item:hover {
            background: #2a2b32;
        }

        .history-item.active {
            background: #343541;
        }

        .history-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }

        .history-actions {
            display: none;
            gap: 4px;
        }

        .history-item:hover .history-actions {
            display: flex;
        }

        .history-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #8e8ea0;
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: #40414f;
            color: #ececf1;
        }

        .rename-input {
            background: #40414f;
            border: 1px solid #565869;
            color: #ececf1;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        /* ä¾§è¾¹æ åº•éƒ¨ */
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid #444654;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-info:hover {
            background: #2a2b32;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            flex: 1;
            font-size: 14px;
            color: #ececf1;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #343541;
        }

        .chat-header {
            padding: 16px 24px;
            background: #343541;
            border-bottom: 1px solid #444654;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #ececf1;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: #8e8ea0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #40414f;
            color: #ececf1;
        }

        /* èŠå¤©å®¹å™¨ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* æ¬¢è¿å±å¹• */
        .chat-welcome {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            padding: 60px 24px;
        }

        .welcome-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            color: #ececf1;
            margin-bottom: 12px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #8e8ea0;
            margin-bottom: 40px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 32px;
        }

        .quick-action-card {
            background: #444654;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-action-card:hover {
            background: #4a4b5a;
            transform: translateY(-2px);
        }

        .quick-action-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .quick-action-title {
            font-size: 16px;
            font-weight: 600;
            color: #ececf1;
            margin-bottom: 8px;
        }

        .quick-action-desc {
            font-size: 13px;
            color: #8e8ea0;
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: #19c37d;
            color: white;
        }

        .message-content {
            flex: 1;
            background: #444654;
            padding: 16px;
            border-radius: 12px;
            color: #ececf1;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #343541;
        }

        .message-time {
            font-size: 12px;
            color: #8e8ea0;
            margin-top: 8px;
        }

        /* æ–‡ä»¶é™„ä»¶æ˜¾ç¤º */
        .message-files {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #40414f;
            border-radius: 16px;
            font-size: 13px;
            color: #ececf1;
        }

        .file-chip-icon {
            font-size: 14px;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-container {
            padding: 24px;
            background: #343541;
            border-top: 1px solid #444654;
        }

        .input-area {
            max-width: 800px;
            margin: 0 auto;
            background: #40414f;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* æ–‡ä»¶é¢„è§ˆåŒºåŸŸ */
        .file-preview-area {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #565869;
        }

        .file-preview-area.show {
            display: flex;
        }

        .file-preview-item {
            position: relative;
            background: #343541;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 200px;
        }

        .file-preview-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .file-preview-img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .file-preview-info {
            flex: 1;
            min-width: 0;
        }

        .file-preview-name {
            font-size: 13px;
            color: #ececf1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-preview-size {
            font-size: 11px;
            color: #8e8ea0;
        }

        .file-remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: #ef4444;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .file-remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* è¾“å…¥æ¡†å’ŒæŒ‰é’® */
        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            color: #ececf1;
            font-size: 15px;
            resize: none;
            outline: none;
            max-height: 200px;
            min-height: 24px;
            line-height: 24px;
            font-family: inherit;
        }

        #messageInput::placeholder {
            color: #8e8ea0;
        }

        .input-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .file-upload-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: #8e8ea0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .file-upload-btn:hover {
            background: #565869;
            color: #ececf1;
        }

        .send-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: #19c37d;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #15a368;
        }

        .send-btn:disabled {
            background: #565869;
            cursor: not-allowed;
        }

        /* åŠŸèƒ½åˆ‡æ¢ */
        .feature-toggles {
            display: flex;
            gap: 8px;
            padding-top: 8px;
            border-top: 1px solid #565869;
        }

        .toggle-chip {
            padding: 6px 12px;
            background: #343541;
            border: 1px solid #565869;
            border-radius: 16px;
            font-size: 13px;
            color: #8e8ea0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-chip:hover {
            background: #40414f;
            color: #ececf1;
        }

        .toggle-chip.active {
            background: #19c37d;
            color: white;
            border-color: #19c37d;
        }

        /* åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8e8ea0;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* æ»šåŠ¨æ¡ */
        .chat-history::-webkit-scrollbar,
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history::-webkit-scrollbar-track,
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-history::-webkit-scrollbar-thumb,
        .chat-container::-webkit-scrollbar-thumb {
            background: #565869;
            border-radius: 4px;
        }

        .chat-history::-webkit-scrollbar-thumb:hover,
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #6e6f7e;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #343541;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            color: #ececf1;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            background: #40414f;
            border: 1px solid #565869;
            border-radius: 8px;
            color: #ececf1;
            font-size: 14px;
            margin-top: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: #19c37d;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #15a368;
        }

        .modal-btn.secondary {
            background: #40414f;
            color: #ececf1;
        }

        .modal-btn.secondary:hover {
            background: #565869;
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewConversation()">
                â• æ–°å¯¹è¯
            </button>
        </div>

        <div class="chat-history" id="chatHistory">
            <!-- é¡¹ç›®åŒºåŸŸ -->
            <div class="projects-section">
                <div class="section-header">
                    <span>ğŸ“ é¡¹ç›®</span>
                    <button class="add-project-btn" onclick="showCreateProjectModal()" title="æ–°å»ºé¡¹ç›®">+</button>
                </div>
                <div id="projectsList">
                    <!-- é¡¹ç›®åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <!-- å¯¹è¯å†å² -->
            <div id="conversationsList">
                <!-- å¯¹è¯åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-info" id="userInfo">
                <div class="user-avatar">æˆ‘</div>
                <div class="user-name">Junjun HU</div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="chat-header">
            <div class="chat-title" id="chatTitle">ä»Šå¤©æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ ï¼Ÿ</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="window.close()" title="å…³é—­">âœ•</button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-welcome" id="welcomeScreen">
                <div class="welcome-icon">ğŸ¤–</div>
                <div class="welcome-title">ä»Šå¤©æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ ï¼Ÿ</div>
                <div class="welcome-subtitle">DeepSeek AI åŠ©æ‰‹ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ ã€æ·±åº¦æ€è€ƒã€è”ç½‘æœç´¢</div>

                <div class="quick-actions">
                    <div class="quick-action-card" onclick="useQuickAction('åˆ›å»ºæ˜å¤©ä¸Šåˆ9ç‚¹åˆ°12ç‚¹çš„å®‰è£…å·¥å•ï¼Œåœ°ç‚¹æµ¦ä¸œå¼ æ±Ÿï¼Œè½¦ç‰Œæ²ªAÂ·12345ï¼Œå®‰è£…äººå‘˜ææ˜')">
                        <div class="quick-action-icon">ğŸ“…</div>
                        <div class="quick-action-title">åˆ›å»ºæ—¥ç¨‹</div>
                        <div class="quick-action-desc">AIè‡ªåŠ¨åˆ›å»ºå·¥å•åˆ°æ—¥å†</div>
                    </div>

                    <div class="quick-action-card" onclick="useQuickAction('åˆ†ææœ¬æœˆå·¥å•åˆ†å¸ƒæƒ…å†µï¼Œæä¾›ä¼˜åŒ–å»ºè®®')">
                        <div class="quick-action-icon">ğŸ“Š</div>
                        <div class="quick-action-title">æ•°æ®åˆ†æ</div>
                        <div class="quick-action-desc">åˆ†æå·¥å•è¶‹åŠ¿å’Œæ¨¡å¼</div>
                    </div>

                    <div class="quick-action-card" onclick="document.getElementById('fileInput').click()">
                        <div class="quick-action-icon">ğŸ“</div>
                        <div class="quick-action-title">ä¸Šä¼ æ–‡ä»¶</div>
                        <div class="quick-action-desc">æ”¯æŒå›¾ç‰‡ã€PDFã€æ–‡æ¡£ç­‰</div>
                    </div>

                    <div class="quick-action-card" onclick="useQuickAction('è¯·å¸®æˆ‘ä¼˜åŒ–ä»¥ä¸‹å·¥å•è·¯çº¿...')">
                        <div class="quick-action-icon">ğŸ—ºï¸</div>
                        <div class="quick-action-title">è·¯çº¿ä¼˜åŒ–</div>
                        <div class="quick-action-desc">æ™ºèƒ½è§„åˆ’å·¥å•é¡ºåº</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-container">
            <div class="input-area">
                <!-- æ–‡ä»¶é¢„è§ˆåŒº -->
                <div class="file-preview-area" id="filePreviewArea"></div>

                <!-- è¾“å…¥è¡Œ -->
                <div class="input-row">
                    <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                    <div class="input-actions">
                        <input type="file" id="fileInput" style="display: none" multiple onchange="handleFileSelect(event)">
                        <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn">â–²</button>
                    </div>
                </div>

                <!-- åŠŸèƒ½åˆ‡æ¢ -->
                <div class="feature-toggles">
                    <div class="toggle-chip" onclick="toggleWebSearch()" id="webSearchToggle">
                        ğŸŒ è”ç½‘æœç´¢
                    </div>
                    <div class="toggle-chip" onclick="toggleDeepThink()" id="deepThinkToggle">
                        ğŸ§  æ·±åº¦æ€è€ƒ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºé¡¹ç›®æ¨¡æ€æ¡† -->
    <div class="modal" id="createProjectModal">
        <div class="modal-content">
            <div class="modal-header">åˆ›å»ºæ–°é¡¹ç›®</div>
            <div class="modal-body">
                <label for="projectNameInput">é¡¹ç›®åç§°</label>
                <input type="text" id="projectNameInput" class="modal-input" placeholder="ä¾‹å¦‚ï¼šå®‰è£…å·¥å•ç®¡ç†">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('createProjectModal')">å–æ¶ˆ</button>
                <button class="modal-btn primary" onclick="createProject()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ°é¡¹ç›®æ¨¡æ€æ¡† -->
    <div class="modal" id="addToProjectModal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ åˆ°é¡¹ç›®</div>
            <div class="modal-body">
                <label>é€‰æ‹©é¡¹ç›®</label>
                <select id="projectSelect" class="modal-input">
                    <!-- åŠ¨æ€åŠ è½½é¡¹ç›®åˆ—è¡¨ -->
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('addToProjectModal')">å–æ¶ˆ</button>
                <button class="modal-btn primary" onclick="addConversationToProject()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script src="app-config.js"></script>
    <script>
        // ============ å…¨å±€å˜é‡ ============
        let webSearchEnabled = false;
        let deepThinkEnabled = false;
        let conversationHistory = [];
        let conversations = []; // æ‰€æœ‰å¯¹è¯åˆ—è¡¨
        let projects = []; // é¡¹ç›®åˆ—è¡¨
        let currentConversationId = null; // å½“å‰å¯¹è¯ID
        let uploadedFiles = []; // ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
        let tempConversationIdForProject = null; // ä¸´æ—¶å­˜å‚¨è¦æ·»åŠ åˆ°é¡¹ç›®çš„å¯¹è¯ID

        // ============ é¡µé¢åˆå§‹åŒ– ============
        window.addEventListener('load', () => {
            loadData();
            initUserInfo();
            initDragDrop();
            initTextareaAutoResize();
        });

        // åŠ è½½æ‰€æœ‰æ•°æ®
        function loadData() {
            loadProjects();
            loadConversations();
        }

        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        function initUserInfo() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const user = JSON.parse(currentUser);
                const userNameEl = document.querySelector('.user-name');
                const userAvatarEl = document.querySelector('.user-avatar');
                if (userNameEl && user.username) {
                    userNameEl.textContent = user.username;
                    userAvatarEl.textContent = user.username.charAt(0).toUpperCase();
                }
            }
        }

        // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ 
        function initDragDrop() {
            const inputArea = document.querySelector('.input-area');
            
            inputArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                inputArea.style.background = '#4a4b5a';
            });

            inputArea.addEventListener('dragleave', () => {
                inputArea.style.background = '#40414f';
            });

            inputArea.addEventListener('drop', (e) => {
                e.preventDefault();
                inputArea.style.background = '#40414f';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFiles(files);
                }
            });
        }

        // åˆå§‹åŒ–æ–‡æœ¬æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        function initTextareaAutoResize() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // ============ é¡¹ç›®ç®¡ç† ============
        // åŠ è½½é¡¹ç›®
        function loadProjects() {
            const saved = localStorage.getItem('ai_projects');
            if (saved) {
                projects = JSON.parse(saved);
            }
            renderProjects();
        }

        // ä¿å­˜é¡¹ç›®
        function saveProjects() {
            localStorage.setItem('ai_projects', JSON.stringify(projects));
        }

        // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            
            if (projects.length === 0) {
                projectsList.innerHTML = '<div style="padding: 8px 12px; font-size: 12px; color: #8e8ea0;">æš‚æ— é¡¹ç›®</div>';
                return;
            }

            let html = '';
            projects.forEach(project => {
                const conversationIds = project.conversationIds || [];
                const isExpanded = project.expanded || false;
                
                html += `
                    <div class="project-item">
                        <div class="project-header">
                            <button class="project-toggle ${isExpanded ? 'expanded' : ''}" onclick="toggleProject('${project.id}')">â–¶</button>
                            <span class="project-icon">ğŸ“</span>
                            <span class="project-name" ondblclick="renameProject('${project.id}')">${project.name}</span>
                            <div class="project-actions">
                                <button class="project-btn" onclick="renameProject('${project.id}')" title="é‡å‘½å">âœï¸</button>
                                <button class="project-btn" onclick="deleteProject('${project.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="project-conversations ${isExpanded ? 'show' : ''}" id="project-${project.id}-conversations">
                            ${renderProjectConversations(conversationIds)}
                        </div>
                    </div>
                `;
            });

            projectsList.innerHTML = html;
        }

        // æ¸²æŸ“é¡¹ç›®ä¸­çš„å¯¹è¯
        function renderProjectConversations(conversationIds) {
            if (conversationIds.length === 0) {
                return '<div style="padding: 8px; font-size: 12px; color: #8e8ea0;">æš‚æ— å¯¹è¯</div>';
            }

            let html = '';
            conversationIds.forEach(id => {
                const conv = conversations.find(c => c.id === id);
                if (conv) {
                    const isActive = conv.id === currentConversationId;
                    html += `
                        <div class="history-item ${isActive ? 'active' : ''}" onclick="switchConversation(${conv.id})">
                            <span class="history-text">${conv.title}</span>
                            <div class="history-actions">
                                <button class="history-btn" onclick="event.stopPropagation(); removeFromProject('${conv.id}')" title="ç§»å‡ºé¡¹ç›®">âŒ</button>
                            </div>
                        </div>
                    `;
                }
            });

            return html;
        }

        // æ˜¾ç¤ºåˆ›å»ºé¡¹ç›®æ¨¡æ€æ¡†
        function showCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('show');
            document.getElementById('projectNameInput').value = '';
            setTimeout(() => document.getElementById('projectNameInput').focus(), 100);
        }

        // åˆ›å»ºé¡¹ç›®
        function createProject() {
            const input = document.getElementById('projectNameInput');
            const name = input.value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥é¡¹ç›®åç§°');
                return;
            }

            const project = {
                id: Date.now().toString(),
                name: name,
                conversationIds: [],
                expanded: false,
                createdAt: new Date().toISOString()
            };

            projects.push(project);
            saveProjects();
            renderProjects();
            closeModal('createProjectModal');
        }

        // åˆ‡æ¢é¡¹ç›®å±•å¼€/æ”¶èµ·
        function toggleProject(projectId) {
            event.stopPropagation();
            const project = projects.find(p => p.id === projectId);
            if (project) {
                project.expanded = !project.expanded;
                saveProjects();
                renderProjects();
            }
        }

        // é‡å‘½åé¡¹ç›®
        function renameProject(projectId) {
            event.stopPropagation();
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const newName = prompt('é‡å‘½åé¡¹ç›®:', project.name);
            if (newName && newName.trim()) {
                project.name = newName.trim();
                saveProjects();
                renderProjects();
            }
        }

        // åˆ é™¤é¡¹ç›®
        function deleteProject(projectId) {
            event.stopPropagation();
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿé¡¹ç›®ä¸­çš„å¯¹è¯ä¸ä¼šè¢«åˆ é™¤ã€‚')) return;

            projects = projects.filter(p => p.id !== projectId);
            saveProjects();
            renderProjects();
        }

        // æ˜¾ç¤ºæ·»åŠ åˆ°é¡¹ç›®æ¨¡æ€æ¡†
        function showAddToProjectModal(conversationId) {
            event.stopPropagation();
            tempConversationIdForProject = conversationId;
            
            const select = document.getElementById('projectSelect');
            let options = '<option value="">é€‰æ‹©é¡¹ç›®...</option>';
            
            projects.forEach(project => {
                options += `<option value="${project.id}">${project.name}</option>`;
            });
            
            select.innerHTML = options;
            document.getElementById('addToProjectModal').classList.add('show');
        }

        // æ·»åŠ å¯¹è¯åˆ°é¡¹ç›®
        function addConversationToProject() {
            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) {
                alert('è¯·é€‰æ‹©é¡¹ç›®');
                return;
            }

            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            if (!project.conversationIds.includes(tempConversationIdForProject)) {
                project.conversationIds.push(tempConversationIdForProject);
                saveProjects();
                renderProjects();
                renderConversations();
            }

            closeModal('addToProjectModal');
            tempConversationIdForProject = null;
        }

        // ä»é¡¹ç›®ä¸­ç§»é™¤å¯¹è¯
        function removeFromProject(conversationId) {
            event.stopPropagation();
            
            projects.forEach(project => {
                const index = project.conversationIds.indexOf(conversationId);
                if (index > -1) {
                    project.conversationIds.splice(index, 1);
                }
            });

            saveProjects();
            renderProjects();
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // ============ å¯¹è¯ç®¡ç† ============
        // åŠ è½½æ‰€æœ‰å¯¹è¯
        function loadConversations() {
            const saved = localStorage.getItem('ai_conversations');
            if (saved) {
                conversations = JSON.parse(saved);
            }

            // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤å¯¹è¯
            if (conversations.length === 0) {
                createNewConversation();
                return;
            }

            // è®¾ç½®å½“å‰å¯¹è¯
            if (!currentConversationId && conversations.length > 0) {
                currentConversationId = conversations[0].id;
            }

            renderConversations();
            loadCurrentConversation();
        }

        // ä¿å­˜æ‰€æœ‰å¯¹è¯
        function saveConversations() {
            localStorage.setItem('ai_conversations', JSON.stringify(conversations));
        }

        // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
        function renderConversations() {
            const conversationsList = document.getElementById('conversationsList');
            
            // è·å–ä¸åœ¨ä»»ä½•é¡¹ç›®ä¸­çš„å¯¹è¯
            const conversationsInProjects = new Set();
            projects.forEach(project => {
                project.conversationIds.forEach(id => conversationsInProjects.add(id));
            });

            const freeConversations = conversations.filter(conv => !conversationsInProjects.has(conv.id));
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const grouped = groupConversationsByDate(freeConversations);
            
            let html = '';
            for (const [dateLabel, convs] of Object.entries(grouped)) {
                html += `<div class="history-section">
                    <div class="history-title">${dateLabel}</div>`;
                
                convs.forEach(conv => {
                    const isActive = conv.id === currentConversationId;
                    html += `
                        <div class="history-item ${isActive ? 'active' : ''}" onclick="switchConversation(${conv.id})">
                            <span class="history-text">${conv.title}</span>
                            <div class="history-actions">
                                <button class="history-btn" onclick="event.stopPropagation(); showAddToProjectModal(${conv.id})" title="æ·»åŠ åˆ°é¡¹ç›®">ğŸ“</button>
                                <button class="history-btn" onclick="event.stopPropagation(); renameConversation(${conv.id})" title="é‡å‘½å">âœï¸</button>
                                <button class="history-btn" onclick="event.stopPropagation(); deleteConversation(${conv.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            conversationsList.innerHTML = html;
        }

        // æŒ‰æ—¥æœŸåˆ†ç»„å¯¹è¯
        function groupConversationsByDate(convs) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const grouped = {
                'ä»Šå¤©': [],
                'æ˜¨å¤©': [],
                'æœ€è¿‘ 7 å¤©': [],
                'æœ€è¿‘ 30 å¤©': [],
            };

            const monthGroups = {};

            convs.forEach(conv => {
                const convDate = new Date(conv.updatedAt || conv.createdAt);
                const convDay = new Date(convDate.getFullYear(), convDate.getMonth(), convDate.getDate());

                if (convDay.getTime() === today.getTime()) {
                    grouped['ä»Šå¤©'].push(conv);
                } else if (convDay.getTime() === yesterday.getTime()) {
                    grouped['æ˜¨å¤©'].push(conv);
                } else if (convDay >= sevenDaysAgo) {
                    grouped['æœ€è¿‘ 7 å¤©'].push(conv);
                } else if (convDay >= thirtyDaysAgo) {
                    grouped['æœ€è¿‘ 30 å¤©'].push(conv);
                } else {
                    const monthKey = `${convDate.getFullYear()}å¹´${convDate.getMonth() + 1}æœˆ`;
                    if (!monthGroups[monthKey]) {
                        monthGroups[monthKey] = [];
                    }
                    monthGroups[monthKey].push(conv);
                }
            });

            // ç§»é™¤ç©ºåˆ†ç»„
            Object.keys(grouped).forEach(key => {
                if (grouped[key].length === 0) {
                    delete grouped[key];
                }
            });

            // åˆå¹¶æœˆä»½åˆ†ç»„
            return { ...grouped, ...monthGroups };
        }

        // åˆ›å»ºæ–°å¯¹è¯
        function createNewConversation() {
            const newConv = {
                id: Date.now(),
                title: 'æ–°å¯¹è¯',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            conversations.unshift(newConv);
            currentConversationId = newConv.id;
            
            saveConversations();
            renderConversations();
            loadCurrentConversation();
        }

        // åˆ‡æ¢å¯¹è¯
        function switchConversation(convId) {
            currentConversationId = convId;
            renderConversations();
            renderProjects(); // æ›´æ–°é¡¹ç›®ä¸­çš„å¯¹è¯é«˜äº®
            loadCurrentConversation();
        }

        // åŠ è½½å½“å‰å¯¹è¯
        function loadCurrentConversation() {
            const conv = conversations.find(c => c.id === currentConversationId);
            if (!conv) return;

            const chatContainer = document.getElementById('chatContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatTitle = document.getElementById('chatTitle');

            // æ›´æ–°æ ‡é¢˜
            chatTitle.textContent = conv.title;

            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿ç•Œé¢
            if (conv.messages.length === 0) {
                welcomeScreen.style.display = 'block';
                // ç§»é™¤æ‰€æœ‰æ¶ˆæ¯
                const messages = chatContainer.querySelectorAll('.message');
                messages.forEach(msg => msg.remove());
                return;
            }

            // éšè—æ¬¢è¿ç•Œé¢
            welcomeScreen.style.display = 'none';

            // æ¸…ç©ºå®¹å™¨
            chatContainer.innerHTML = '';

            // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
            conv.messages.forEach(msg => {
                addMessageToUI(msg.role, msg.content, msg.files);
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }

        // é‡å‘½åå¯¹è¯
        function renameConversation(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;

            const newTitle = prompt('é‡å‘½åå¯¹è¯:', conv.title);
            if (newTitle && newTitle.trim()) {
                conv.title = newTitle.trim();
                conv.updatedAt = new Date().toISOString();
                saveConversations();
                renderConversations();
                renderProjects();
                
                if (convId === currentConversationId) {
                    document.getElementById('chatTitle').textContent = conv.title;
                }
            }
        }

        // åˆ é™¤å¯¹è¯
        function deleteConversation(convId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) return;

            // ä»é¡¹ç›®ä¸­ç§»é™¤
            removeFromProject(convId);

            // åˆ é™¤å¯¹è¯
            conversations = conversations.filter(c => c.id !== convId);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå¯¹è¯
            if (convId === currentConversationId) {
                if (conversations.length > 0) {
                    currentConversationId = conversations[0].id;
                } else {
                    createNewConversation();
                    return;
                }
            }

            saveConversations();
            renderConversations();
            renderProjects();
            loadCurrentConversation();
        }

        // ä¿å­˜æ¶ˆæ¯åˆ°å¯¹è¯
        function saveMessageToConversation(role, content, files = []) {
            const conv = conversations.find(c => c.id === currentConversationId);
            if (!conv) return;

            const message = {
                role: role,
                content: content,
                files: files,
                timestamp: new Date().toISOString()
            };

            conv.messages.push(message);
            conv.updatedAt = new Date().toISOString();

            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œç”¨å®ƒä½œä¸ºæ ‡é¢˜
            if (conv.messages.length === 1 && role === 'user') {
                conv.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                document.getElementById('chatTitle').textContent = conv.title;
            }

            saveConversations();
            renderConversations();
            renderProjects();
        }

        // ============ æ–‡ä»¶å¤„ç† ============
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                handleFiles(files);
            }
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                // é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æ–‡ä»¶ ${file.name} å¤ªå¤§ï¼Œæœ€å¤§æ”¯æŒ10MB`);
                    return;
                }

                uploadedFiles.push(file);
                addFilePreview(file);
            });

            // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆåŒº
            if (uploadedFiles.length > 0) {
                document.getElementById('filePreviewArea').classList.add('show');
            }
        }

        // æ·»åŠ æ–‡ä»¶é¢„è§ˆ
        function addFilePreview(file) {
            const previewArea = document.getElementById('filePreviewArea');
            const fileIndex = uploadedFiles.length - 1;

            const previewDiv = document.createElement('div');
            previewDiv.className = 'file-preview-item';
            previewDiv.id = `file-preview-${fileIndex}`;

            // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ˜¾ç¤ºç¼©ç•¥å›¾
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.className = 'file-preview-img';
                img.src = URL.createObjectURL(file);
                previewDiv.appendChild(img);
            } else {
                // å…¶ä»–æ–‡ä»¶æ˜¾ç¤ºå›¾æ ‡
                const icon = document.createElement('div');
                icon.className = 'file-preview-icon';
                icon.textContent = getFileIcon(file);
                previewDiv.appendChild(icon);
            }

            const info = document.createElement('div');
            info.className = 'file-preview-info';
            info.innerHTML = `
                <div class="file-preview-name">${file.name}</div>
                <div class="file-preview-size">${formatFileSize(file.size)}</div>
            `;
            previewDiv.appendChild(info);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'file-remove-btn';
            removeBtn.textContent = 'âœ•';
            removeBtn.onclick = () => removeFile(fileIndex);
            previewDiv.appendChild(removeBtn);

            previewArea.appendChild(previewDiv);
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'ğŸ“„',
                'doc': 'ğŸ“', 'docx': 'ğŸ“',
                'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š',
                'txt': 'ğŸ“ƒ',
                'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦',
                'mp3': 'ğŸµ', 'wav': 'ğŸµ',
                'mp4': 'ğŸ¬', 'avi': 'ğŸ¬',
            };
            return iconMap[ext] || 'ğŸ“';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            
            // é‡æ–°æ¸²æŸ“æ–‡ä»¶é¢„è§ˆ
            const previewArea = document.getElementById('filePreviewArea');
            previewArea.innerHTML = '';
            
            uploadedFiles.forEach((file, idx) => {
                addFilePreview(file);
            });

            // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—é¢„è§ˆåŒº
            if (uploadedFiles.length === 0) {
                previewArea.classList.remove('show');
            }
        }

        // ============ å‘é€æ¶ˆæ¯ ============
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message && uploadedFiles.length === 0) return;

            // å‡†å¤‡æ–‡ä»¶ä¿¡æ¯
            const fileInfos = uploadedFiles.map(file => ({
                name: file.name,
                type: file.type,
                size: file.size
            }));

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessageToUI('user', message, fileInfos);
            saveMessageToConversation('user', message, fileInfos);

            // æ¸…ç©ºè¾“å…¥
            input.value = '';
            input.style.height = 'auto';
            
            // æ¸…ç©ºæ–‡ä»¶
            uploadedFiles = [];
            document.getElementById('filePreviewArea').innerHTML = '';
            document.getElementById('filePreviewArea').classList.remove('show');

            // éšè—æ¬¢è¿ç•Œé¢
            document.getElementById('welcomeScreen').style.display = 'none';

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            showTypingIndicator();

            // æ„å»ºæ¶ˆæ¯å†å²
            const conv = conversations.find(c => c.id === currentConversationId);
            conversationHistory = conv ? conv.messages.map(msg => ({
                role: msg.role,
                content: msg.content
            })) : [];

            // è°ƒç”¨AI
            try {
                await callAI(message);
            } catch (error) {
                console.error('AIè°ƒç”¨å¤±è´¥:', error);
                hideTypingIndicator();
                addMessageToUI('assistant', 'æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚');
                saveMessageToConversation('assistant', 'æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(indicator);
            scrollToBottom();
        }

        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // è°ƒç”¨AI
        async function callAI(userMessage) {
            try {
                const response = await fetchWithAuth('/ai/chat', {
                    method: 'POST',
                    body: JSON.stringify({
                        messages: conversationHistory,
                        mode: 'chat',
                        deepThink: deepThinkEnabled
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                hideTypingIndicator();

                const aiMessage = data.choices[0].message.content;
                addMessageToUI('assistant', aiMessage);
                saveMessageToConversation('assistant', aiMessage);

            } catch (error) {
                console.error('AIè°ƒç”¨é”™è¯¯:', error);
                hideTypingIndicator();
                const errorMsg = 'æŠ±æ­‰ï¼ŒAIæœåŠ¡è°ƒç”¨å¤±è´¥: ' + error.message;
                addMessageToUI('assistant', errorMsg);
                saveMessageToConversation('assistant', errorMsg);
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°UI
        function addMessageToUI(role, content, files = []) {
            const chatContainer = document.getElementById('chatContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'æˆ‘' : 'ğŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // å¤„ç†æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒMarkdownç­‰ï¼‰
            contentDiv.innerHTML = formatMessage(content);

            // å¦‚æœæœ‰æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            if (files && files.length > 0) {
                const filesDiv = document.createElement('div');
                filesDiv.className = 'message-files';
                files.forEach(file => {
                    const fileChip = document.createElement('div');
                    fileChip.className = 'file-chip';
                    fileChip.innerHTML = `
                        <span class="file-chip-icon">${getFileIcon(file)}</span>
                        <span>${file.name}</span>
                    `;
                    filesDiv.appendChild(fileChip);
                });
                contentDiv.appendChild(filesDiv);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);

            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯ï¼ˆç®€å•å¤„ç†ï¼Œå¯ä»¥å¢å¼ºï¼‰
        function formatMessage(text) {
            // è½¬ä¹‰HTML
            text = text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;');
            
            // å¤„ç†æ¢è¡Œ
            text = text.replace(/\n/g, '<br>');
            
            // ç®€å•çš„ä»£ç å—å¤„ç†
            text = text.replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>');
            
            // è¡Œå†…ä»£ç 
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // ç²—ä½“
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            return text;
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ============ åŠŸèƒ½åˆ‡æ¢ ============
        function toggleWebSearch() {
            webSearchEnabled = !webSearchEnabled;
            const toggle = document.getElementById('webSearchToggle');
            if (webSearchEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function toggleDeepThink() {
            deepThinkEnabled = !deepThinkEnabled;
            const toggle = document.getElementById('deepThinkToggle');
            if (deepThinkEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        // ============ å¿«æ·æ“ä½œ ============
        function useQuickAction(text) {
            document.getElementById('messageInput').value = text;
            document.getElementById('messageInput').focus();
        }
    </script>
</body>
</html>
