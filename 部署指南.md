# 🚀 工程安装月历管理系统 - 部署指南

## 目录
1. [部署前准备](#部署前准备)
2. [方案一：云服务器部署（推荐）](#方案一云服务器部署推荐)
3. [方案二：Vercel部署（免费快速）](#方案二vercel部署免费快速)
4. [方案三：Docker部署（标准化）](#方案三docker部署标准化)
5. [方案四：内网部署](#方案四内网部署)
6. [域名和HTTPS配置](#域名和https配置)
7. [性能优化建议](#性能优化建议)

---

## 部署前准备

### 1. 检查清单
- [ ] 所有功能测试通过
- [ ] 修改默认密码和JWT密钥
- [ ] 配置生产环境的环境变量
- [ ] 准备数据库（如需要）
- [ ] 备份数据文件

### 2. 安全配置

#### 修改环境变量
编辑 `backend/.env`：
```bash
# 生产环境配置
NODE_ENV=production
PORT=3000

# 修改为强密码（至少32位随机字符）
JWT_SECRET=your-production-jwt-secret-min-32-chars

# DeepSeek API密钥
DEEPSEEK_API_KEY=sk-your-real-api-key

# 数据库配置（如果使用）
DB_HOST=localhost
DB_PORT=5432
DB_NAME=calendar_db
DB_USER=calendar_user
DB_PASSWORD=strong-password

# CORS配置
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

#### 生成强JWT密钥
在终端运行：
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. 修改默认账号
编辑 `backend/src/db.js`，修改管理员密码：
```javascript
users: [
    {
        id: 1,
        username: 'admin',
        password: '$2a$10$新的加密密码', // 使用bcrypt加密
        role: 'admin',
        email: 'admin@yourdomain.com'
    }
]
```

生成加密密码：
```bash
cd backend
node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('你的新密码', 10));"
```

---

## 方案一：云服务器部署（推荐）

### 适用场景
- 企业级应用
- 需要完全控制
- 数据敏感性高
- 支持大量用户

### 推荐云服务商
- **阿里云ECS** - 国内访问快
- **腾讯云CVM** - 性价比高
- **AWS EC2** - 全球部署
- **DigitalOcean** - 简单易用

### 服务器配置要求

#### 小型团队（<50用户）
- CPU: 2核
- 内存: 2GB
- 硬盘: 40GB SSD
- 带宽: 3Mbps
- 操作系统: Ubuntu 22.04 LTS

#### 中型团队（50-200用户）
- CPU: 4核
- 内存: 4GB
- 硬盘: 80GB SSD
- 带宽: 5Mbps
- 操作系统: Ubuntu 22.04 LTS

### 详细部署步骤

#### 1. 连接到服务器
```bash
ssh root@your-server-ip
```

#### 2. 安装Node.js
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node --version
npm --version
```

#### 3. 安装Nginx
```bash
sudo apt install -y nginx

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 4. 上传项目代码

**方法A：使用Git（推荐）**
```bash
# 安装Git
sudo apt install -y git

# 克隆项目
cd /var/www
sudo git clone https://github.com/yourusername/xiezuoCalendar.git
cd xiezuoCalendar
```

**方法B：使用SCP上传**
```bash
# 在本地电脑运行
scp -r e:\Work\xiezuoCalendar root@your-server-ip:/var/www/
```

#### 5. 安装依赖
```bash
cd /var/www/xiezuoCalendar/backend
npm install --production

# 如果需要安装Socket.IO
npm install socket.io
```

#### 6. 配置环境变量
```bash
# 创建.env文件
nano /var/www/xiezuoCalendar/backend/.env
```

粘贴配置：
```bash
NODE_ENV=production
PORT=3000
JWT_SECRET=你的强密钥
DEEPSEEK_API_KEY=sk-your-api-key
```

#### 7. 配置Nginx反向代理
```bash
sudo nano /etc/nginx/sites-available/calendar
```

粘贴配置：
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # 静态文件
    location / {
        root /var/www/xiezuoCalendar;
        try_files $uri $uri/ /installation_schedule.html;
        index installation_schedule.html;
    }

    location /frontend/ {
        alias /var/www/xiezuoCalendar/frontend/;
        try_files $uri $uri/ =404;
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # WebSocket支持
    location /socket.io/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 86400;
    }

    # 文件上传大小限制
    client_max_body_size 50M;
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/calendar /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 8. 使用PM2管理Node进程
```bash
# 安装PM2
sudo npm install -g pm2

# 启动应用
cd /var/www/xiezuoCalendar/backend
pm2 start src/index.js --name calendar-backend

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status
pm2 logs calendar-backend
```

#### 9. 配置防火墙
```bash
# 允许SSH、HTTP、HTTPS
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable
sudo ufw status
```

#### 10. 验证部署
访问：`http://your-server-ip` 或 `http://your-domain.com`

---

## 方案二：Vercel部署（免费快速）

### 特点
- ✅ 完全免费
- ✅ 自动HTTPS
- ✅ 全球CDN
- ✅ 自动部署
- ⚠️ 后端需要改为Serverless

### 部署步骤

#### 1. 安装Vercel CLI
```bash
npm install -g vercel
```

#### 2. 创建vercel.json配置
在项目根目录创建 `vercel.json`：
```json
{
  "version": 2,
  "builds": [
    {
      "src": "backend/src/index.js",
      "use": "@vercel/node"
    },
    {
      "src": "frontend/**",
      "use": "@vercel/static"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "backend/src/index.js"
    },
    {
      "src": "/frontend/(.*)",
      "dest": "/frontend/$1"
    },
    {
      "src": "/(.*)",
      "dest": "/$1"
    }
  ]
}
```

#### 3. 部署
```bash
cd e:\Work\xiezuoCalendar
vercel
```

按提示操作：
1. 登录Vercel账号
2. 设置项目名称
3. 确认配置
4. 等待部署完成

#### 4. 配置环境变量
在Vercel Dashboard：
1. 进入项目设置
2. 找到 Environment Variables
3. 添加：
   - `JWT_SECRET`
   - `DEEPSEEK_API_KEY`
   - `NODE_ENV=production`

---

## 方案三：Docker部署（标准化）

### 优势
- 环境一致性
- 易于迁移
- 快速部署
- 隔离性好

### 部署步骤

#### 1. 创建Dockerfile
在项目根目录创建 `Dockerfile`：
```dockerfile
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制package.json
COPY backend/package*.json ./backend/

# 安装依赖
RUN cd backend && npm install --production

# 复制项目文件
COPY . .

# 暴露端口
EXPOSE 3000

# 设置环境变量
ENV NODE_ENV=production

# 启动应用
CMD ["node", "backend/src/index.js"]
```

#### 2. 创建docker-compose.yml
```yaml
version: '3.8'

services:
  calendar-app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
    volumes:
      - ./backend/data:/app/backend/data
      - ./backend/uploads:/app/backend/uploads
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./frontend:/usr/share/nginx/html/frontend
      - ./installation_schedule.html:/usr/share/nginx/html/installation_schedule.html
    depends_on:
      - calendar-app
    restart: unless-stopped
```

#### 3. 创建.env文件
```bash
JWT_SECRET=your-strong-secret-key
DEEPSEEK_API_KEY=sk-your-api-key
```

#### 4. 部署
```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止
docker-compose down

# 重启
docker-compose restart
```

---

## 方案四：内网部署

### 适用场景
- 公司内部使用
- 数据不出内网
- 无需公网访问

### 部署步骤

#### 1. 在内网服务器安装
按照"方案一"的步骤1-8操作

#### 2. 配置固定IP
编辑 `/etc/netplan/00-installer-config.yaml`：
```yaml
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: no
      addresses:
        - 192.168.1.100/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
```

应用配置：
```bash
sudo netplan apply
```

#### 3. 配置局域网DNS（可选）
在路由器或DNS服务器添加：
```
calendar.local -> 192.168.1.100
```

#### 4. 访问
内网用户访问：`http://192.168.1.100` 或 `http://calendar.local`

---

## 域名和HTTPS配置

### 1. 购买域名
推荐域名注册商：
- 阿里云万网
- 腾讯云DNSPod
- GoDaddy
- Namecheap

### 2. DNS解析
添加A记录：
```
类型: A
主机记录: @
记录值: your-server-ip
TTL: 600

类型: A
主机记录: www
记录值: your-server-ip
TTL: 600
```

### 3. 配置HTTPS（Let's Encrypt免费证书）

#### 安装Certbot
```bash
sudo apt install -y certbot python3-certbot-nginx
```

#### 获取SSL证书
```bash
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
```

按提示输入邮箱，同意条款。

#### 自动续期
Certbot会自动设置定时任务，也可手动测试：
```bash
sudo certbot renew --dry-run
```

#### Nginx HTTPS配置（自动生成）
Certbot会自动修改Nginx配置，添加：
```nginx
server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    # ... 其他配置
}

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 性能优化建议

### 1. 前端优化

#### 压缩静态资源
```bash
# 安装压缩工具
sudo apt install -y gzip brotli

# 压缩文件
find frontend -name "*.html" -o -name "*.js" -o -name "*.css" | xargs gzip -k
```

#### Nginx启用Gzip
在 `/etc/nginx/nginx.conf` 中：
```nginx
http {
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
}
```

### 2. 后端优化

#### 使用Redis缓存
```bash
# 安装Redis
sudo apt install -y redis-server
sudo systemctl enable redis-server
```

修改 `backend/src/index.js`，添加Redis缓存：
```javascript
const redis = require('redis');
const client = redis.createClient();

// 缓存API响应
app.get('/api/tasks', async (req, res) => {
    const cached = await client.get('tasks');
    if (cached) {
        return res.json(JSON.parse(cached));
    }
    
    const data = await getData();
    await client.setEx('tasks', 60, JSON.stringify(data)); // 缓存60秒
    res.json(data);
});
```

### 3. 数据库优化

#### 迁移到PostgreSQL（推荐）
```bash
# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 创建数据库
sudo -u postgres psql
CREATE DATABASE calendar_db;
CREATE USER calendar_user WITH ENCRYPTED PASSWORD 'strong-password';
GRANT ALL PRIVILEGES ON DATABASE calendar_db TO calendar_user;
```

安装Node.js PostgreSQL客户端：
```bash
cd backend
npm install pg
```

### 4. 监控和日志

#### 安装监控工具
```bash
# PM2监控
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7

# 系统监控
pm2 install pm2-server-monit
```

#### Nginx访问日志
```bash
# 查看访问日志
sudo tail -f /var/log/nginx/access.log

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

---

## 备份策略

### 1. 自动备份脚本
创建 `/root/backup.sh`：
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库文件
tar -czf $BACKUP_DIR/data_$DATE.tar.gz /var/www/xiezuoCalendar/backend/data

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/www/xiezuoCalendar/backend/uploads

# 删除7天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
```

设置定时任务：
```bash
chmod +x /root/backup.sh

# 添加到crontab（每天凌晨2点执行）
crontab -e
# 添加：
0 2 * * * /root/backup.sh >> /var/log/backup.log 2>&1
```

### 2. 远程备份
```bash
# 备份到云存储（阿里云OSS示例）
# 安装ossutil
wget http://gosspublic.alicdn.com/ossutil/1.7.14/ossutil64
chmod 755 ossutil64

# 配置
./ossutil64 config

# 上传备份
./ossutil64 cp /backup/*.tar.gz oss://your-bucket/backup/
```

---

## 故障排除

### 常见问题

#### 1. 无法访问
**检查：**
```bash
# 检查防火墙
sudo ufw status

# 检查Nginx状态
sudo systemctl status nginx

# 检查端口占用
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :3000

# 检查应用日志
pm2 logs calendar-backend
```

#### 2. WebSocket连接失败
**检查Nginx配置：**
```nginx
# 确保有以下配置
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

#### 3. 性能问题
**检查资源使用：**
```bash
# CPU和内存
htop

# PM2监控
pm2 monit

# Nginx状态
curl http://localhost/nginx_status
```

---

## 安全加固

### 1. 修改SSH端口
```bash
sudo nano /etc/ssh/sshd_config
# 修改：Port 22 -> Port 2222
sudo systemctl restart sshd
```

### 2. 禁用root登录
```bash
# 创建普通用户
sudo adduser deploy
sudo usermod -aG sudo deploy

# 修改SSH配置
sudo nano /etc/ssh/sshd_config
# 修改：PermitRootLogin yes -> PermitRootLogin no
```

### 3. 安装Fail2ban
```bash
sudo apt install -y fail2ban
sudo systemctl enable fail2ban
```

### 4. 配置CORS
在 `backend/src/index.js`：
```javascript
const cors = require('cors');

app.use(cors({
    origin: process.env.ALLOWED_ORIGINS?.split(',') || '*',
    credentials: true
}));
```

---

## 成本估算

### 云服务器方案（阿里云示例）
- **服务器**: ¥80-200/月（2核2G-4核4G）
- **带宽**: ¥20-50/月（3-5Mbps）
- **域名**: ¥55/年（.com）
- **SSL证书**: 免费（Let's Encrypt）
- **总计**: 约¥100-250/月

### Vercel方案
- **免费额度**: 100GB带宽/月
- **升级版**: $20/月（无限带宽）
- **适合**: 小团队快速上线

---

## 推荐部署方案对比

| 方案 | 成本 | 难度 | 性能 | 适用场景 |
|------|------|------|------|----------|
| 云服务器 | ¥100-250/月 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 企业级生产环境 |
| Vercel | 免费-$20/月 | ⭐ | ⭐⭐⭐⭐ | 快速上线、小团队 |
| Docker | ¥100-250/月 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 标准化部署 |
| 内网部署 | 服务器成本 | ⭐⭐ | ⭐⭐⭐⭐ | 企业内部系统 |

---

## 下一步行动清单

### 立即行动
- [ ] 选择部署方案
- [ ] 购买服务器/域名
- [ ] 修改环境变量和密码
- [ ] 备份本地数据

### 部署中
- [ ] 上传代码到服务器
- [ ] 安装依赖
- [ ] 配置Nginx
- [ ] 启动服务
- [ ] 配置HTTPS

### 部署后
- [ ] 功能测试
- [ ] 性能测试
- [ ] 安全检查
- [ ] 设置监控和备份
- [ ] 编写运维文档

---

## 技术支持

遇到问题？
1. 查看服务器日志：`pm2 logs`
2. 查看Nginx日志：`/var/log/nginx/error.log`
3. 检查防火墙设置
4. 验证环境变量配置

---

**祝您部署顺利！🚀**
