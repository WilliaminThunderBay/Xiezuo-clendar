# é€šçŸ¥ç³»ç»Ÿä½¿ç”¨è¯´æ˜Ž

## ðŸ“‹ åŠŸèƒ½æ¦‚è¿°

é€šçŸ¥ç³»ç»Ÿä¸ºå·¥ç¨‹å®‰è£…æœˆåŽ†ç®¡ç†ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æ¶ˆæ¯æé†’åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- âœ… å·¥å•è‡ªåŠ¨æé†’ï¼ˆå³å°†å¼€å§‹ã€é€¾æœŸç­‰ï¼‰
- âœ… å·¥ä½œé‡é¢„è­¦
- âœ… å®žæ—¶æœªè¯»é€šçŸ¥æ•°æ˜¾ç¤º
- âœ… é€šçŸ¥ä¸­å¿ƒç»Ÿä¸€ç®¡ç†
- âœ… å¤šç§é€šçŸ¥ç±»åž‹ï¼ˆæ¶ˆæ¯ã€æˆåŠŸã€è­¦å‘Šã€é”™è¯¯ï¼‰

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åŽç«¯æœåŠ¡

```bash
cd backend
npm install  # ç¡®ä¿å·²å®‰è£… node-cron ä¾èµ–
npm start
```

æœåŠ¡å¯åŠ¨åŽï¼Œé€šçŸ¥è°ƒåº¦å™¨ä¼šè‡ªåŠ¨å¼€å§‹è¿è¡Œï¼š
- æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å·¥å•æé†’
- æ¯å¤©æ—©ä¸Š8ç‚¹æ£€æŸ¥å‘˜å·¥å·¥ä½œé‡

### 2. è®¿é—®é€šçŸ¥ä¸­å¿ƒ

åœ¨ä¸»é¡µé¢å³ä¸Šè§’ç‚¹å‡» ðŸ”” å›¾æ ‡ï¼Œæˆ–ç›´æŽ¥è®¿é—®ï¼š
```
http://localhost:ç«¯å£å·/notification-center.html
```

### 3. æŸ¥çœ‹æœªè¯»é€šçŸ¥

- ä¸»é¡µé¢å³ä¸Šè§’çš„ ðŸ”” å›¾æ ‡ä¼šæ˜¾ç¤ºæœªè¯»é€šçŸ¥æ•°é‡
- çº¢è‰²å¾½ç« ä¼šå®žæ—¶æ›´æ–°
- æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡

## ðŸ“Œ API æŽ¥å£è¯´æ˜Ž

### é€šçŸ¥è·¯ç”± `/api/notifications`

#### 1. èŽ·å–é€šçŸ¥åˆ—è¡¨
```
GET /api/notifications
éœ€è¦è®¤è¯: âœ…

è¿”å›žç¤ºä¾‹:
{
  "notifications": [
    {
      "id": "notif-1234567890",
      "title": "å·¥å•æé†’",
      "message": "å·¥å• WO-2024-001 å³å°†å¼€å§‹ï¼ˆè¿˜æœ‰ 30 åˆ†é’Ÿï¼‰",
      "type": "warning",
      "userId": "user-123",
      "taskId": "task-456",
      "link": "/installation_schedule.html?taskId=task-456",
      "read": false,
      "createdAt": "2024-01-15T10:30:00.000Z"
    }
  ]
}
```

#### 2. åˆ›å»ºé€šçŸ¥
```
POST /api/notifications
éœ€è¦è®¤è¯: âœ…

è¯·æ±‚ä½“:
{
  "title": "é€šçŸ¥æ ‡é¢˜",
  "message": "é€šçŸ¥å†…å®¹",
  "type": "info",        // info, success, warning, error
  "userId": "all",       // ç”¨æˆ·ID æˆ– "all" è¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·
  "taskId": "task-123",  // å¯é€‰ï¼šå…³è”çš„å·¥å•ID
  "link": "/page.html"   // å¯é€‰ï¼šç‚¹å‡»è·³è½¬é“¾æŽ¥
}
```

#### 3. æ ‡è®°ä¸ºå·²è¯»
```
PUT /api/notifications/:id/read
éœ€è¦è®¤è¯: âœ…
```

#### 4. å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»
```
PUT /api/notifications/read-all
éœ€è¦è®¤è¯: âœ…
```

#### 5. åˆ é™¤é€šçŸ¥
```
DELETE /api/notifications/:id
éœ€è¦è®¤è¯: âœ…
```

#### 6. èŽ·å–æœªè¯»æ•°é‡
```
GET /api/notifications/unread-count
éœ€è¦è®¤è¯: âœ…

è¿”å›žç¤ºä¾‹:
{
  "count": 5
}
```

#### 7. åˆ›å»ºå·¥å•æé†’
```
POST /api/notifications/task-reminder
éœ€è¦è®¤è¯: âœ…

è¯·æ±‚ä½“:
{
  "taskId": "task-123"
}
```

## ðŸ”” è‡ªåŠ¨æé†’è§„åˆ™

### å·¥å•æé†’

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰æœªå®Œæˆçš„å·¥å•ï¼Œå¹¶æ ¹æ®æ—¶é—´å‘é€æé†’ï¼š

| æ—¶é—´æ¡ä»¶ | é€šçŸ¥ç±»åž‹ | ç¤ºä¾‹æ¶ˆæ¯ |
|---------|---------|---------|
| å·²é€¾æœŸ | âŒ é”™è¯¯ | å·¥å• WO-2024-001 å·²é€¾æœŸ 5 å°æ—¶ |
| 2å°æ—¶å†…å¼€å§‹ | âš ï¸ è­¦å‘Š | å·¥å• WO-2024-001 å³å°†å¼€å§‹ï¼ˆè¿˜æœ‰ 90 åˆ†é’Ÿï¼‰ |
| ä»Šå¤©å¼€å§‹ | ðŸ“˜ æ¶ˆæ¯ | å·¥å• WO-2024-001 å°†äºŽä»Šå¤© 14:00 å¼€å§‹ |

**æé†’é¢‘çŽ‡**ï¼šæ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œ1å°æ—¶å†…ä¸é‡å¤å‘é€ç›¸åŒæé†’

### å·¥ä½œé‡é¢„è­¦

- å½“å‘˜å·¥å½“å¤©æœªå®Œæˆå·¥å•è¶…è¿‡ **5ä¸ª** æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å‘é€å·¥ä½œé‡é¢„è­¦
- å‘é€ç»™æ‰€æœ‰ç®¡ç†å‘˜
- æ¯å¤©åªå‘é€ä¸€æ¬¡ï¼ˆæ—©ä¸Š8ç‚¹æ£€æŸ¥ï¼‰

## ðŸŽ¨ é€šçŸ¥ç±»åž‹

### 1. ðŸ“˜ æ¶ˆæ¯ (info)
- é¢œè‰²ï¼šè“è‰²
- ç”¨é€”ï¼šä¸€èˆ¬ä¿¡æ¯é€šçŸ¥

### 2. âœ… æˆåŠŸ (success)
- é¢œè‰²ï¼šç»¿è‰²
- ç”¨é€”ï¼šæ“ä½œæˆåŠŸã€ä»»åŠ¡å®Œæˆ

### 3. âš ï¸ è­¦å‘Š (warning)
- é¢œè‰²ï¼šæ©™è‰²
- ç”¨é€”ï¼šéœ€è¦æ³¨æ„çš„äº‹é¡¹ã€å³å°†åˆ°æœŸ

### 4. âŒ é”™è¯¯ (error)
- é¢œè‰²ï¼šçº¢è‰²
- ç”¨é€”ï¼šä¸¥é‡é—®é¢˜ã€é€¾æœŸæé†’

## ðŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ‰‹åŠ¨åˆ›å»ºé€šçŸ¥

```javascript
// åœ¨å‰ç«¯ä»£ç ä¸­
async function sendCustomNotification() {
  await fetchWithAuth(`${API_BASE_URL}/api/notifications`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: 'ç³»ç»Ÿç»´æŠ¤é€šçŸ¥',
      message: 'ç³»ç»Ÿå°†äºŽä»Šæ™š22:00è¿›è¡Œç»´æŠ¤ï¼Œé¢„è®¡æŒç»­1å°æ—¶',
      type: 'warning',
      userId: 'all'  // å‘é€ç»™æ‰€æœ‰ç”¨æˆ·
    })
  });
}
```

### åœºæ™¯2ï¼šå·¥å•åˆ›å»ºåŽæé†’è´Ÿè´£äºº

```javascript
async function createTaskAndNotify(taskData) {
  // 1. åˆ›å»ºå·¥å•
  const taskResponse = await fetchWithAuth(`${API_BASE_URL}/api/tasks`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(taskData)
  });
  
  const task = await taskResponse.json();
  
  // 2. åˆ›å»ºé€šçŸ¥
  await fetchWithAuth(`${API_BASE_URL}/api/notifications`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: 'æ–°å·¥å•åˆ†é…',
      message: `æ‚¨æœ‰æ–°çš„å·¥å•ï¼š${task.number} - ${task.location}`,
      type: 'info',
      userId: task.staffId,  // å‘é€ç»™è´Ÿè´£äºº
      taskId: task.id,
      link: `/installation_schedule.html?taskId=${task.id}`
    })
  });
}
```

### åœºæ™¯3ï¼šæ‰¹é‡é€šçŸ¥æ‰€æœ‰åœ¨çº¿ç”¨æˆ·

```javascript
async function notifyAllUsers() {
  await fetchWithAuth(`${API_BASE_URL}/api/notifications`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: 'ä¼šè®®é€šçŸ¥',
      message: 'å…¨ä½“ä¼šè®®å°†äºŽä¸‹åˆ3ç‚¹åœ¨ä¼šè®®å®¤å¬å¼€',
      type: 'info',
      userId: 'all'  // æ‰€æœ‰ç”¨æˆ·
    })
  });
}
```

## ðŸ”§ é…ç½®é€‰é¡¹

### ä¿®æ”¹æ£€æŸ¥é¢‘çŽ‡

ç¼–è¾‘ `backend/src/scheduler.js`ï¼š

```javascript
// å·¥å•æé†’æ£€æŸ¥é¢‘çŽ‡ï¼ˆé»˜è®¤ï¼šæ¯30åˆ†é’Ÿï¼‰
cron.schedule('*/30 * * * *', () => {
  checkTaskReminders();
});

// ä¿®æ”¹ä¸ºæ¯15åˆ†é’Ÿï¼š
cron.schedule('*/15 * * * *', () => {
  checkTaskReminders();
});
```

### ä¿®æ”¹å·¥ä½œé‡é˜ˆå€¼

ç¼–è¾‘ `backend/src/scheduler.js`ï¼š

```javascript
// é»˜è®¤é˜ˆå€¼ï¼š5ä¸ªæœªå®Œæˆå·¥å•
if (workload.pending > 5) {
  // å‘é€é¢„è­¦
}

// ä¿®æ”¹ä¸º3ä¸ªï¼š
if (workload.pending > 3) {
  // å‘é€é¢„è­¦
}
```

### ä¿®æ”¹æé†’æ—¶é—´ç‚¹

ç¼–è¾‘ `backend/src/scheduler.js`ï¼š

```javascript
// 2å°æ—¶å†…æé†’
else if (hoursUntil > 0 && hoursUntil <= 2) {
  shouldNotify = true;
  type = 'warning';
}

// ä¿®æ”¹ä¸º4å°æ—¶å†…æé†’ï¼š
else if (hoursUntil > 0 && hoursUntil <= 4) {
  shouldNotify = true;
  type = 'warning';
}
```

## ðŸ“± ç”¨æˆ·ç•Œé¢

### é€šçŸ¥ä¸­å¿ƒç•Œé¢åŠŸèƒ½

1. **ç­›é€‰åŠŸèƒ½**
   - å…¨éƒ¨é€šçŸ¥
   - ä»…æœªè¯»
   - æŒ‰ç±»åž‹ç­›é€‰ï¼ˆæ¶ˆæ¯ã€æˆåŠŸã€è­¦å‘Šã€é”™è¯¯ï¼‰

2. **æ“ä½œåŠŸèƒ½**
   - ç‚¹å‡»é€šçŸ¥æ ‡è®°ä¸ºå·²è¯»
   - æŸ¥çœ‹è¯¦æƒ…ï¼ˆè·³è½¬åˆ°ç›¸å…³é¡µé¢ï¼‰
   - åˆ é™¤é€šçŸ¥
   - å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»

3. **æ—¶é—´æ˜¾ç¤º**
   - åˆšåˆš
   - Xåˆ†é’Ÿå‰
   - Xå°æ—¶å‰
   - Xå¤©å‰
   - å…·ä½“æ—¥æœŸ

### ä¸»é¡µé¢é€šçŸ¥æç¤º

- ðŸ”” å›¾æ ‡ä½ç½®ï¼šå³ä¸Šè§’ï¼Œåä½œæŒ‰é’®æ—
- æœªè¯»å¾½ç« ï¼šçº¢è‰²ï¼Œæ˜¾ç¤ºæœªè¯»æ•°é‡
- ç‚¹å‡»è·³è½¬ï¼šç›´æŽ¥è¿›å…¥é€šçŸ¥ä¸­å¿ƒ
- è‡ªåŠ¨åˆ·æ–°ï¼šæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡

## ðŸ› æ•…éšœæŽ’æŸ¥

### é—®é¢˜1ï¼šé€šçŸ¥æ²¡æœ‰è‡ªåŠ¨å‘é€

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤åŽç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
2. æ£€æŸ¥æŽ§åˆ¶å°æ˜¯å¦æœ‰è°ƒåº¦å™¨å¯åŠ¨æ—¥å¿—
3. æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

```bash
# æŸ¥çœ‹åŽç«¯æ—¥å¿—
cd backend
npm start

# åº”è¯¥çœ‹åˆ°ï¼š
é€šçŸ¥è°ƒåº¦å™¨å·²å¯åŠ¨
æ‰§è¡Œå·¥å•æé†’æ£€æŸ¥...
```

### é—®é¢˜2ï¼šæœªè¯»æ•°é‡ä¸æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
2. ç¡®è®¤JWT tokenæ˜¯å¦æœ‰æ•ˆ
3. æ‰‹åŠ¨åˆ·æ–°é¡µé¢

### é—®é¢˜3ï¼šé€šçŸ¥é‡å¤å‘é€

**åŽŸå› **ï¼š
- 1å°æ—¶é˜²é‡å¤æœºåˆ¶å¯èƒ½å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„é€šçŸ¥åˆ›å»ºæ—¶é—´
2. é‡å¯åŽç«¯æœåŠ¡

## ðŸ“Š æ•°æ®å­˜å‚¨

é€šçŸ¥æ•°æ®å­˜å‚¨åœ¨ `backend/data/db.json` ä¸­ï¼š

```json
{
  "notifications": [
    {
      "id": "notif-1234567890",
      "title": "å·¥å•æé†’",
      "message": "å·¥å•å†…å®¹",
      "type": "info",
      "userId": "user-123",
      "taskId": "task-456",
      "link": "/page.html",
      "read": false,
      "createdAt": "2024-01-15T10:30:00.000Z"
    }
  ]
}
```

**æ³¨æ„**ï¼š
- ç³»ç»Ÿè‡ªåŠ¨ä¿ç•™æœ€è¿‘1000æ¡é€šçŸ¥
- è¶…è¿‡1000æ¡ä¼šè‡ªåŠ¨åˆ é™¤æ—§é€šçŸ¥
- å»ºè®®å®šæœŸå¤‡ä»½æ•°æ®

## ðŸŽ¯ æœ€ä½³å®žè·µ

1. **åˆç†è®¾ç½®æé†’æ—¶é—´**
   - ä¸è¦è¿‡äºŽé¢‘ç¹ï¼Œé¿å…æ‰“æ‰°ç”¨æˆ·
   - é‡è¦é€šçŸ¥å¯ä»¥å¤šæ¬¡æé†’

2. **é€šçŸ¥å†…å®¹æ¸…æ™°**
   - æ ‡é¢˜ç®€æ´æ˜Žäº†
   - å†…å®¹åŒ…å«å…³é”®ä¿¡æ¯ï¼ˆå·¥å•å·ã€æ—¶é—´ã€åœ°ç‚¹ç­‰ï¼‰

3. **ä½¿ç”¨åˆé€‚çš„é€šçŸ¥ç±»åž‹**
   - ä¸€èˆ¬ä¿¡æ¯ç”¨ info
   - ç´§æ€¥æƒ…å†µç”¨ error
   - éœ€è¦æ³¨æ„ç”¨ warning

4. **æä¾›æ“ä½œå…¥å£**
   - é€šçŸ¥ä¸­åŒ…å« linkï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æŽ¥è·³è½¬å¤„ç†

5. **å®šæœŸæ¸…ç†é€šçŸ¥**
   - å»ºè®®ç”¨æˆ·å®šæœŸåˆ é™¤å·²å¤„ç†çš„é€šçŸ¥
   - ç³»ç»Ÿè‡ªåŠ¨é™åˆ¶é€šçŸ¥æ•°é‡

## ðŸ“ˆ æœªæ¥æ‰©å±•

å¯ä»¥è¿›ä¸€æ­¥å¢žå¼ºçš„åŠŸèƒ½ï¼š

1. **é‚®ä»¶é€šçŸ¥**
   - é›†æˆ Nodemailer
   - å‘é€é‚®ä»¶æé†’

2. **çŸ­ä¿¡é€šçŸ¥**
   - é›†æˆçŸ­ä¿¡æœåŠ¡
   - ç´§æ€¥æƒ…å†µå‘é€çŸ­ä¿¡

3. **å¾®ä¿¡é€šçŸ¥**
   - ä¼ä¸šå¾®ä¿¡æœºå™¨äºº
   - å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯

4. **æŽ¨é€é€šçŸ¥**
   - Web Push API
   - æµè§ˆå™¨åŽŸç”ŸæŽ¨é€

5. **é€šçŸ¥åå¥½è®¾ç½®**
   - ç”¨æˆ·è‡ªå®šä¹‰æŽ¥æ”¶ç±»åž‹
   - å…æ‰“æ‰°æ—¶æ®µè®¾ç½®

---

**ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´1æœˆ  
**ä½œè€…**: GitHub Copilot
