# 在线协作功能 - 快速使用指南

## 🚀 系统已启动

服务器地址: **http://localhost:3000**

## 📍 主要页面

### 1. 协作中心
**URL**: http://localhost:3000/frontend/collaboration.html

**功能**:
- 👥 实时在线用户列表
- 💬 团队即时聊天
- ⚡ 实时活动动态
- ✏️ 正在编辑任务状态
- 📊 协作统计数据

### 2. 主日历系统
**URL**: http://localhost:3000/frontend/installation_schedule.html

**集成功能**:
- 任务CRUD操作
- 在线协作面板
- 活动日志

### 3. 登录页面
**URL**: http://localhost:3000/frontend/login.html

**默认账号**:
- 用户名: `admin`
- 密码: `12345`

## ✨ 核心功能

### 实时协作

```javascript
// WebSocket 自动连接
// 页面加载时自动建立连接，显示连接状态

// 功能特性：
- ✅ 实时显示在线用户
- ✅ 任务编辑状态同步
- ✅ 光标位置追踪
- ✅ 内容变更实时推送
```

### 评论系统

**API 端点**:
```
GET  /api/comments/task/:taskId  - 获取任务评论
POST /api/comments               - 添加评论
PUT  /api/comments/:id           - 编辑评论
DELETE /api/comments/:id         - 删除评论
POST /api/comments/:id/like      - 点赞评论
GET  /api/comments/stats/:taskId - 获取统计
```

**使用示例**:
```javascript
// 添加评论
await fetchWithAuth('/api/comments', {
  method: 'POST',
  body: JSON.stringify({
    taskId: 'task-123',
    content: '@张三 请检查这个任务',
    mentions: ['user-456']
  })
});
```

### 版本历史

**API 端点**:
```
GET  /api/versions/task/:taskId    - 获取版本历史
POST /api/versions                 - 创建版本快照
GET  /api/versions/timeline/:taskId - 获取时间线
```

**功能**:
- 自动版本保存
- 版本比较
- 一键回滚
- 版本标签

### 实时聊天

**API 端点**:
```
GET  /api/chat?limit=50&offset=0  - 获取消息
POST /api/chat                     - 发送消息
GET  /api/chat/stats               - 获取统计
```

**特性**:
- @mention 提醒
- 消息回复
- 表情反应
- 实时推送

### 协作分析

**API 端点**:
```
GET /api/collaboration/overview        - 协作概览
GET /api/collaboration/feature-adoption - 功能采用率
```

**统计指标**:
- 协作项目比例
- 活跃协作者数
- 评论使用率
- 实时协作事件

## 🎯 使用流程

### 1. 登录系统
```
1. 访问 http://localhost:3000
2. 输入用户名: admin
3. 输入密码: 12345
4. 点击登录
```

### 2. 查看协作中心
```
1. 登录后点击导航栏的"协作中心"
2. 查看在线用户列表
3. 在聊天框发送消息
4. 查看实时活动和统计
```

### 3. 协作编辑任务
```
1. 在主日历系统中选择任务
2. 系统自动通知其他用户你正在编辑
3. 其他用户的修改会实时显示
4. 编辑完成后自动创建版本快照
```

### 4. 添加评论讨论
```
1. 在任务详情页点击"添加评论"
2. 输入评论内容（使用 @用户名 提及他人）
3. 被@的用户会立即收到通知
4. 支持点赞和回复评论
```

### 5. 查看版本历史
```
1. 在任务详情页点击"版本历史"
2. 查看所有变更记录
3. 比较不同版本的差异
4. 可一键回滚到历史版本
```

## 🔔 通知系统

### 通知类型
- **任务通知**: 任务分配、状态变更、截止提醒
- **评论通知**: 新评论、@提及、回复
- **聊天通知**: @提及、未读消息
- **系统通知**: 重要公告、系统更新

### 查看通知
```
1. 点击右上角铃铛图标
2. 查看未读通知数量
3. 点击通知查看详情
4. 支持全部标记已读
```

## 📊 数据统计

访问协作中心查看实时统计：

- **活跃协作者**: 当前在线和活跃用户数
- **今日活动**: 今天的所有协作活动
- **今日评论**: 今天新增的评论数
- **聊天消息**: 聊天消息总数
- **协作项目比例**: 有协作的任务占比

## 🛠️ API 认证

所有 API 请求需要在 Header 中携带 JWT Token：

```javascript
Authorization: Bearer <your-jwt-token>
```

使用 `fetchWithAuth` 辅助函数（已在 app-config.js 中定义）：

```javascript
const response = await fetchWithAuth('/api/comments/task/123');
```

## 🔧 WebSocket 连接

### 连接管理
```javascript
// 自动连接（已集成）
const token = localStorage.getItem('token');
window.collaborationClient.connect(token);

// 监听连接状态
window.collaborationClient.on('connected', () => {
  console.log('协作功能已启用');
});
```

### 事件监听
```javascript
// 监听用户上线
window.collaborationClient.on('user-online', (data) => {
  console.log(`${data.username} 上线了`);
});

// 监听聊天消息
window.collaborationClient.on('chat-message', (msg) => {
  displayMessage(msg);
});

// 监听任务更新
window.collaborationClient.on('task-updated', (data) => {
  refreshTask(data.taskId);
});
```

## ⚠️ 常见问题

### Q: WebSocket 连接失败？
**A**: 
1. 检查服务器是否运行（http://localhost:3000）
2. 清除浏览器缓存并刷新页面
3. 检查 token 是否有效（重新登录）

### Q: 消息未实时更新？
**A**: 
1. 查看连接状态指示器（协作中心右上角）
2. 如果显示"已断开"，刷新页面重新连接
3. 检查浏览器控制台是否有错误

### Q: 评论无法发送？
**A**: 
1. 检查网络连接
2. 确认 token 未过期（重新登录）
3. 查看浏览器控制台的网络请求

### Q: 看不到其他用户的操作？
**A**: 
1. 确认 WebSocket 已连接
2. 确认其他用户也在线
3. 尝试刷新页面

## 📝 最佳实践

### 1. 频繁保存
- 系统会自动创建版本快照
- 重要变更建议手动添加版本标签
- 定期查看版本历史

### 2. 有效沟通
- 使用 @mention 提醒相关人员
- 在评论中清晰描述问题
- 及时回复他人的评论

### 3. 协作编辑
- 编辑前查看是否有人正在编辑
- 避免同时修改同一字段
- 发生冲突时查看版本历史解决

### 4. 定期查看
- 每天查看通知中心
- 关注协作统计数据
- 了解团队协作情况

## 🎓 学习资源

### 完整文档
详细的 API 文档和技术说明请查看：
```
docs/在线协作功能文档.md
```

### 代码示例
- `frontend/collaboration-client.js` - WebSocket 客户端示例
- `frontend/collaboration.html` - 完整的协作 UI 实现
- `backend/src/websocket.js` - WebSocket 服务器实现

## 🚀 下一步

1. ✅ 登录系统 (http://localhost:3000)
2. ✅ 访问协作中心查看功能
3. ✅ 尝试发送聊天消息
4. ✅ 创建或编辑任务体验实时协作
5. ✅ 添加评论并使用 @mention
6. ✅ 查看版本历史和统计数据

---

**系统版本**: v2.0 with Collaboration Features  
**文档更新**: 2024-10-20  
**技术支持**: 查看完整文档或控制台日志排查问题
